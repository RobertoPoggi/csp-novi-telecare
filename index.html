<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleCare H24 v3.6.13 FINAL - CSP Novi Ligure</title>
    
    <!-- Icona Castello di Novi Ligure - Incorporata (NO dipendenze esterne) -->
    <!-- Favicon per tutti i browser - SVG Base64 incorporato -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIFNmb25kbyBjaXJjb2xhcmUgY29uIGdyYWRpZW50ZSAtLT4KICA8Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1NiIgZmlsbD0idXJsKCNiZ0dyYWRpZW50KSIvPgogIAogIDwhLS0gVG9ycmUgZGVsIGNhc3RlbGxvIC0gZGVzaWduIG1pbmltYWxpc3RhIGNvbWUgZGEgb3JpZ2luYWxlIC0tPgogIDxnIGZpbGw9IndoaXRlIj4KICAgIDwhLS0gQ29ycG8gcHJpbmNpcGFsZSBkZWxsYSB0b3JyZSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTk2IiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE4OCIvPgogICAgCiAgICA8IS0tIDQgTWVybGF0dXJlIHN1cGVyaW9yaSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjIyMSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjI2NSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjMxMCIgeT0iMTY0IiB3aWR0aD0iMjYiIGhlaWdodD0iMzIiLz4KICAgIAogICAgPCEtLSBMaW5lYSBkaSBzZXBhcmF6aW9uZSBzb3R0byBsZSBtZXJsYXR1cmUgLS0+CiAgICA8cmVjdCB4PSIxNzYiIHk9IjE5NiIgd2lkdGg9IjE2MCIgaGVpZ2h0PSI0Ii8+CiAgICAKICAgIDwhLS0gRmVyaXRvaWEgY2VudHJhbGUgKGZpbmVzdHJhIHN0cmV0dGEgdmVydGljYWxlKSAtLT4KICAgIDxyZWN0IHg9IjI0NCIgeT0iMjIwIiB3aWR0aD0iMjQiIGhlaWdodD0iNDgiLz4KICAgIAogICAgPCEtLSBQb3J0YSBhZCBhcmNvIGFsbGEgYmFzZSAtLT4KICAgIDxwYXRoIGQ9Ik0gMjM2IDM0MCBMIDIzNiAzODQgTCAyNzYgMzg0IEwgMjc2IDM0MCBRIDI3NiAzMjUgMjU2IDMyNSBRIDIzNiAzMjUgMjM2IDM0MCBaIi8+CiAgPC9nPgo8L3N2Zz4K">
    <link rel="shortcut icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIFNmb25kbyBjaXJjb2xhcmUgY29uIGdyYWRpZW50ZSAtLT4KICA8Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1NiIgZmlsbD0idXJsKCNiZ0dyYWRpZW50KSIvPgogIAogIDwhLS0gVG9ycmUgZGVsIGNhc3RlbGxvIC0gZGVzaWduIG1pbmltYWxpc3RhIGNvbWUgZGEgb3JpZ2luYWxlIC0tPgogIDxnIGZpbGw9IndoaXRlIj4KICAgIDwhLS0gQ29ycG8gcHJpbmNpcGFsZSBkZWxsYSB0b3JyZSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTk2IiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE4OCIvPgogICAgCiAgICA8IS0tIDQgTWVybGF0dXJlIHN1cGVyaW9yaSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjIyMSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjI2NSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjMxMCIgeT0iMTY0IiB3aWR0aD0iMjYiIGhlaWdodD0iMzIiLz4KICAgIAogICAgPCEtLSBMaW5lYSBkaSBzZXBhcmF6aW9uZSBzb3R0byBsZSBtZXJsYXR1cmUgLS0+CiAgICA8cmVjdCB4PSIxNzYiIHk9IjE5NiIgd2lkdGg9IjE2MCIgaGVpZ2h0PSI0Ii8+CiAgICAKICAgIDwhLS0gRmVyaXRvaWEgY2VudHJhbGUgKGZpbmVzdHJhIHN0cmV0dGEgdmVydGljYWxlKSAtLT4KICAgIDxyZWN0IHg9IjI0NCIgeT0iMjIwIiB3aWR0aD0iMjQiIGhlaWdodD0iNDgiLz4KICAgIAogICAgPCEtLSBQb3J0YSBhZCBhcmNvIGFsbGEgYmFzZSAtLT4KICAgIDxwYXRoIGQ9Ik0gMjM2IDM0MCBMIDIzNiAzODQgTCAyNzYgMzg0IEwgMjc2IDM0MCBRIDI3NiAzMjUgMjU2IDMyNSBRIDIzNiAzMjUgMjM2IDM0MCBaIi8+CiAgPC9nPgo8L3N2Zz4K">
    
    <!-- Apple Touch Icon per iOS/Safari -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIFNmb25kbyBjaXJjb2xhcmUgY29uIGdyYWRpZW50ZSAtLT4KICA8Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1NiIgZmlsbD0idXJsKCNiZ0dyYWRpZW50KSIvPgogIAogIDwhLS0gVG9ycmUgZGVsIGNhc3RlbGxvIC0gZGVzaWduIG1pbmltYWxpc3RhIGNvbWUgZGEgb3JpZ2luYWxlIC0tPgogIDxnIGZpbGw9IndoaXRlIj4KICAgIDwhLS0gQ29ycG8gcHJpbmNpcGFsZSBkZWxsYSB0b3JyZSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTk2IiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE4OCIvPgogICAgCiAgICA8IS0tIDQgTWVybGF0dXJlIHN1cGVyaW9yaSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjIyMSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjI2NSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjMxMCIgeT0iMTY0IiB3aWR0aD0iMjYiIGhlaWdodD0iMzIiLz4KICAgIAogICAgPCEtLSBMaW5lYSBkaSBzZXBhcmF6aW9uZSBzb3R0byBsZSBtZXJsYXR1cmUgLS0+CiAgICA8cmVjdCB4PSIxNzYiIHk9IjE5NiIgd2lkdGg9IjE2MCIgaGVpZ2h0PSI0Ii8+CiAgICAKICAgIDwhLS0gRmVyaXRvaWEgY2VudHJhbGUgKGZpbmVzdHJhIHN0cmV0dGEgdmVydGljYWxlKSAtLT4KICAgIDxyZWN0IHg9IjI0NCIgeT0iMjIwIiB3aWR0aD0iMjQiIGhlaWdodD0iNDgiLz4KICAgIAogICAgPCEtLSBQb3J0YSBhZCBhcmNvIGFsbGEgYmFzZSAtLT4KICAgIDxwYXRoIGQ9Ik0gMjM2IDM0MCBMIDIzNiAzODQgTCAyNzYgMzg0IEwgMjc2IDM0MCBRIDI3NiAzMjUgMjU2IDMyNSBRIDIzNiAzMjUgMjM2IDM0MCBaIi8+CiAgPC9nPgo8L3N2Zz4K">
    
    <!-- Meta tags per web app -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TeleCare H24">
    <meta name="application-name" content="TeleCare H24">
    <meta name="theme-color" content="#667eea">
    
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        /* üì± RESPONSIVE BASE: Smooth scrolling */
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%; /* Previene zoom automatico iOS */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            width: 100%; /* üì± RESPONSIVE */
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .header h1 { 
            font-size: 28px; 
            margin-bottom: 10px; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .castle-icon {
            width: 32px;
            height: 32px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .nav-tabs {
            background: #f8f9fa;
            display: flex;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .nav-tab:hover { background: #e9ecef; }
        
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 48px;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        /* Lista assistiti */
        .assistiti-container {
            margin-top: 20px;
        }
        
        .filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            min-width: 200px;
            cursor: pointer;
        }
        
        .filter-bar label {
            font-weight: 600;
            color: #667eea;
        }
        
        .list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .list-table thead {
            background: #667eea;
            color: white;
        }
        
        .list-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .list-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .list-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Ricerca */
        .search-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            outline: none;
        }
        
        .search-results {
            margin-top: 20px;
            display: grid;
            gap: 15px;
        }
        
        .assistito-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .assistito-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .assistito-info { flex: 1; }
        
        .assistito-nome {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        /* Tabella Comuni */
        .comuni-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .comuni-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .comuni-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .comuni-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .comuni-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .progress-mini {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        .assistito-dettagli {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .assistito-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Form styling */
        .form-section {
            margin-bottom: 35px;
        }
        
        .form-section-title {
            font-size: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea { min-height: 100px; resize: vertical; }
        
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-input-group input {
            text-align: center;
            font-weight: 600;
        }
        
        .age-display {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }
        
        .age-display.empty {
            background: #e9ecef;
            color: #999;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 0;
            display: none;
            z-index: 10000;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            font-size: 18px;
            font-weight: 600;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .caregiver-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }
        
        .caregiver-header {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 22px;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .required {
            color: #dc3545;
            margin-left: 3px;
        }
        
        /* ========================================
           üì± RESPONSIVE DESIGN - MEDIA QUERIES v3.5.5
           ======================================== */
        
        /* üì± MOBILE SMALL (320px - 480px) */
        @media (max-width: 480px) {
            body {
                padding: 0;
                font-size: 14px;
            }
            
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .version-badge {
                position: static;
                display: inline-block;
                margin-bottom: 10px;
                font-size: 11px;
                padding: 4px 10px;
            }
            
            /* Navigation mobile */
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0 5px;
            }
            
            .nav-tab {
                min-width: 80px;
                font-size: 11px;
                padding: 12px 6px;
                white-space: nowrap;
            }
            
            /* Form mobile-first */
            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-group label {
                font-size: 13px;
            }
            
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px; /* Previene zoom iOS */
                padding: 12px;
            }
            
            /* Bottoni touch-friendly */
            .btn {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 48px; /* Touch target size */
            }
            
            .btn-primary,
            .btn-secondary {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            /* Tabelle scrollabili */
            .assistiti-list,
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .assistito-card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .assistito-nome {
                font-size: 15px;
            }
            
            .assistito-dettagli {
                font-size: 12px;
            }
            
            /* Filter bar mobile */
            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-bar select,
            .filter-bar input {
                width: 100%;
                font-size: 16px;
            }
            
            /* Section spacing */
            .section {
                padding: 15px;
            }
            
            .section-title {
                font-size: 16px;
                padding: 10px;
            }
            
            /* Date inputs mobile */
            .date-input-group {
                flex-direction: column;
            }
            
            .date-input-group input {
                width: 100%;
            }
            
            /* Config panel mobile */
            #config-obiettivi-grid {
                grid-template-columns: 1fr;
            }
            
            /* Caregiver cards */
            .caregiver-card {
                padding: 12px;
            }
            
            .caregiver-header {
                font-size: 14px;
                padding: 8px;
            }
            
            /* Messages */
        .message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 0;
            display: none;
            z-index: 10000;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            font-size: 18px;
            font-weight: 600;
        }
            
            /* Loading overlay */
            #loadingText {
                font-size: 16px;
            }
        }
        
        /* üì± MOBILE LARGE (481px - 767px) */
        @media (min-width: 481px) and (max-width: 767px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .nav-tab {
                min-width: 100px;
                font-size: 12px;
                padding: 14px 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .btn {
                padding: 12px 24px;
            }
        }
        
        /* üì± TABLET PORTRAIT (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container {
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 26px;
            }
            
            .nav-tab {
                min-width: 120px;
                font-size: 13px;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 18px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            #config-obiettivi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* üñ•Ô∏è TABLET LANDSCAPE / SMALL DESKTOP (1025px - 1366px) */
        @media (min-width: 1025px) and (max-width: 1366px) {
            .container {
                max-width: 1200px;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* üñ•Ô∏è LARGE DESKTOP (1367px+) */
        @media (min-width: 1367px) {
            .container {
                max-width: 1400px;
            }
            
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }
        
        /* üì± ORIENTATION: Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 10px 20px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .section {
                padding: 10px;
            }
        }
        
        /* üé® ACCESSIBILITY: High contrast mode */
        @media (prefers-contrast: high) {
            .nav-tab {
                border: 2px solid #333;
            }
            
            .btn {
                border: 2px solid #000;
            }
            
            .assistito-card {
                border: 2px solid #333;
            }
        }
        
        /* üé® DARK MODE Support (future-proof) */
        @media (prefers-color-scheme: dark) {
            /* Placeholder for future dark mode implementation */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">v3.6.13 ‚ö°</div>
            <h1><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9ImJnR3JhZGllbnQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojNjY3ZWVhO3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiM3NjRiYTI7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8IS0tIFNmb25kbyBjaXJjb2xhcmUgY29uIGdyYWRpZW50ZSAtLT4KICA8Y2lyY2xlIGN4PSIyNTYiIGN5PSIyNTYiIHI9IjI1NiIgZmlsbD0idXJsKCNiZ0dyYWRpZW50KSIvPgogIAogIDwhLS0gVG9ycmUgZGVsIGNhc3RlbGxvIC0gZGVzaWduIG1pbmltYWxpc3RhIGNvbWUgZGEgb3JpZ2luYWxlIC0tPgogIDxnIGZpbGw9IndoaXRlIj4KICAgIDwhLS0gQ29ycG8gcHJpbmNpcGFsZSBkZWxsYSB0b3JyZSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTk2IiB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE4OCIvPgogICAgCiAgICA8IS0tIDQgTWVybGF0dXJlIHN1cGVyaW9yaSAtLT4KICAgIDxyZWN0IHg9IjE3NiIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjIyMSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjI2NSIgeT0iMTY0IiB3aWR0aD0iMzYiIGhlaWdodD0iMzIiLz4KICAgIDxyZWN0IHg9IjMxMCIgeT0iMTY0IiB3aWR0aD0iMjYiIGhlaWdodD0iMzIiLz4KICAgIAogICAgPCEtLSBMaW5lYSBkaSBzZXBhcmF6aW9uZSBzb3R0byBsZSBtZXJsYXR1cmUgLS0+CiAgICA8cmVjdCB4PSIxNzYiIHk9IjE5NiIgd2lkdGg9IjE2MCIgaGVpZ2h0PSI0Ii8+CiAgICAKICAgIDwhLS0gRmVyaXRvaWEgY2VudHJhbGUgKGZpbmVzdHJhIHN0cmV0dGEgdmVydGljYWxlKSAtLT4KICAgIDxyZWN0IHg9IjI0NCIgeT0iMjIwIiB3aWR0aD0iMjQiIGhlaWdodD0iNDgiLz4KICAgIAogICAgPCEtLSBQb3J0YSBhZCBhcmNvIGFsbGEgYmFzZSAtLT4KICAgIDxwYXRoIGQ9Ik0gMjM2IDM0MCBMIDIzNiAzODQgTCAyNzYgMzg0IEwgMjc2IDM0MCBRIDI3NiAzMjUgMjU2IDMyNSBRIDIzNiAzMjUgMjM2IDM0MCBaIi8+CiAgPC9nPgo8L3N2Zz4K" alt="Castello Novi Ligure" class="castle-icon"> TeleCare H24 - CSP Novi Ligure</h1>
            <p>Progetto FNNA | 50 Assistiti | Dic 2025 - Mar 2026</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('installati')">‚úÖ Installati</button>
            <button class="nav-tab" onclick="switchTab('pianificati')">üìÖ Pianificati</button>
            <button class="nav-tab" onclick="switchTab('ricerca')">üîç Ricerca</button>
            <button class="nav-tab" onclick="nuovaScheda()">‚ûï Nuova</button>
        </div>
        
        <!-- TAB DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="stat-totale">0</span>
                    <span class="stat-label">Totale Assistiti</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-installati">0</span>
                    <span class="stat-label">Dispositivi Installati</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-pianificati">0</span>
                    <span class="stat-label">Installazioni Pianificate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-comuni">0</span>
                    <span class="stat-label">Comuni Coperti</span>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìà Riepilogo Progetto</h2>
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Obiettivo Totale</div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;" id="obiettivo-totale">50</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Termine Progetto</div>
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">30 Novembre 2028</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Progresso</div>
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;" id="dashboard-progress">0%</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Da Completare</div>
                            <div style="font-size: 32px; font-weight: bold; color: #ffc107;" id="dashboard-remaining">100</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Avanzamento Installazioni</div>
                        <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <!-- PANNELLO CONFIGURAZIONE OBIETTIVI -->
                    <div style="margin-top: 30px; background: linear-gradient(135deg, #fff3cd 0%, #ffc107 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #856404;">‚öôÔ∏è Configurazione Obiettivi per Comune</h3>
                            <button onclick="toggleConfigPanel()" style="background: white; border: 2px solid #856404; color: #856404; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                <span id="config-toggle-icon">‚ñº</span> Mostra/Nascondi
                            </button>
                        </div>
                        <div id="config-obiettivi-panel" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;" id="config-obiettivi-grid">
                                <!-- Popolato dinamicamente -->
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="salvaObiettivi()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s;">
                                    üíæ Salva Obiettivi
                                </button>
                                <button onclick="resetObiettivi()" style="background: #dc3545; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-left: 10px; transition: all 0.3s;">
                                    üîÑ Ripristina Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STATISTICA PER COMUNE -->
            <div style="margin-top: 40px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üèòÔ∏è Distribuzione per Comune</h2>
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                    <table class="comuni-table">
                        <thead>
                            <tr>
                                <th>Comune</th>
                                <th style="text-align: center;">Assistiti Attuali</th>
                                <th style="text-align: center;">Installati</th>
                                <th style="text-align: center;">Obiettivo</th>
                                <th style="text-align: center;">% Completamento</th>
                                <th>Avanzamento</th>
                                <th style="text-align: center;">Mancanti</th>
                            </tr>
                        </thead>
                        <tbody id="comuni-table-body">
                            <!-- Popolato dinamicamente da JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="mostraTutteLeSchede()" class="btn btn-primary" style="font-size: 18px;">
                    üìã Visualizza Tutte le Schede
                </button>
            </div>
        </div>
        
        <!-- TAB INSTALLATI -->
        <div id="tab-installati" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">‚úÖ Dispositivi Installati (<span id="count-installati">0</span>)</h2>
            
            <div class="filter-bar">
                <label>Filtra per Comune:</label>
                <select id="filter-comune-installati" onchange="filtraInstallati()">
                    <option value="">üåç Tutti i Comuni</option>
                    <option value="Novi Ligure">Novi Ligure</option>
                    <option value="Arquata Scrivia">Arquata Scrivia</option>
                    <option value="Serravalle Scrivia">Serravalle Scrivia</option>
                    <option value="Gavi">Gavi</option>
                    <option value="Basaluzzo">Basaluzzo</option>
                    <option value="Bosio">Bosio</option>
                    <option value="Cassano Spinola">Cassano Spinola</option>
                    <option value="Fresonara">Fresonara</option>
                    <option value="Pozzolo Formigaro">Pozzolo Formigaro</option>
                    <option value="Stazzano">Stazzano</option>
                    <option value="Tassarolo">Tassarolo</option>
                    <option value="Vignole Borbera">Vignole Borbera</option>
                    <option value="Voltaggio">Voltaggio</option>
                    <option value="Albera Ligure">Albera Ligure</option>
                    <option value="Borghetto Di Borbera">Borghetto Di Borbera</option>
                    <option value="Cabella Ligure">Cabella Ligure</option>
                    <option value="Cantalupo Ligure">Cantalupo Ligure</option>
                    <option value="Capriata D'Orba">Capriata D'Orba</option>
                    <option value="Carrega Ligure">Carrega Ligure</option>
                    <option value="Carrosio">Carrosio</option>
                    <option value="Fraconalto">Fraconalto</option>
                    <option value="Francavilla Bisio">Francavilla Bisio</option>
                    <option value="Grondona">Grondona</option>
                    <option value="Mongiardino Ligure">Mongiardino Ligure</option>
                    <option value="Parodi Ligure">Parodi Ligure</option>
                    <option value="Pasturana">Pasturana</option>
                    <option value="Roccaforte Ligure">Roccaforte Ligure</option>
                    <option value="Rocchetta Ligure">Rocchetta Ligure</option>
                    <option value="San Cristoforo">San Cristoforo</option>
                    <option value="Sardigliano">Sardigliano</option>

                    </select>
            </div>
            
            <div id="lista-installati-full" class="assistiti-container"></div>
        </div>
        
        <!-- TAB PIANIFICATI -->
        <div id="tab-pianificati" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìÖ Installazioni Pianificate (<span id="count-pianificati">0</span>)</h2>
            
            <div class="filter-bar">
                <label>Filtra per Mese:</label>
                <select id="filter-mese-pianificati" onchange="filtraPianificati()">
                    <option value="">üìÖ Tutti i Mesi</option>
                    <option value="Novembre 2025">Novembre 2025</option>
                    <option value="Dicembre 2025">Dicembre 2025</option>
                    <option value="Gennaio 2026">Gennaio 2026</option>
                    <option value="Febbraio 2026">Febbraio 2026</option>
                    <option value="Marzo 2026">Marzo 2026</option>
                </select>
                
                <label>Filtra per Comune:</label>
                <select id="filter-comune-pianificati" onchange="filtraPianificati()">
                    <option value="">üåç Tutti i Comuni</option>
                    <option value="Novi Ligure">Novi Ligure</option>
                    <option value="Arquata Scrivia">Arquata Scrivia</option>
                    <option value="Serravalle Scrivia">Serravalle Scrivia</option>
                    <option value="Gavi">Gavi</option>
                    <option value="Basaluzzo">Basaluzzo</option>
                    <option value="Bosio">Bosio</option>
                    <option value="Cassano Spinola">Cassano Spinola</option>
                    <option value="Fresonara">Fresonara</option>
                    <option value="Pozzolo Formigaro">Pozzolo Formigaro</option>
                    <option value="Stazzano">Stazzano</option>
                    <option value="Tassarolo">Tassarolo</option>
                    <option value="Vignole Borbera">Vignole Borbera</option>
                    <option value="Voltaggio">Voltaggio</option>
                    <option value="Albera Ligure">Albera Ligure</option>
                    <option value="Borghetto Di Borbera">Borghetto Di Borbera</option>
                    <option value="Cabella Ligure">Cabella Ligure</option>
                    <option value="Cantalupo Ligure">Cantalupo Ligure</option>
                    <option value="Capriata D'Orba">Capriata D'Orba</option>
                    <option value="Carrega Ligure">Carrega Ligure</option>
                    <option value="Carrosio">Carrosio</option>
                    <option value="Fraconalto">Fraconalto</option>
                    <option value="Francavilla Bisio">Francavilla Bisio</option>
                    <option value="Grondona">Grondona</option>
                    <option value="Mongiardino Ligure">Mongiardino Ligure</option>
                    <option value="Parodi Ligure">Parodi Ligure</option>
                    <option value="Pasturana">Pasturana</option>
                    <option value="Roccaforte Ligure">Roccaforte Ligure</option>
                    <option value="Rocchetta Ligure">Rocchetta Ligure</option>
                    <option value="San Cristoforo">San Cristoforo</option>
                    <option value="Sardigliano">Sardigliano</option>

                    </select>
            </div>
            
            <div id="lista-pianificati-full" class="assistiti-container"></div>
        </div>
        
        <!-- TAB RICERCA -->
        <div id="tab-ricerca" class="tab-content">
            <div class="search-box">
                <h2 style="margin-bottom: 15px; color: #667eea;">üîç Cerca Assistito</h2>
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="Digita nome, cognome, numero scheda o comune..."
                       onkeyup="cercaAssistito()">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        
        <!-- TAB NUOVA SCHEDA -->
        <div id="tab-nuova" class="tab-content">
            <div class="message" id="messageBox"></div>
            
            <form id="assistitoForm">
                <!-- DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title">üë§ Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="numeroScheda">N¬∞ Scheda<span class="required">*</span></label>
                            <input type="text" id="numeroScheda" name="numeroScheda" required>
                        </div>

                        <div class="form-group">
                            <label for="dataCompilazione">Data Compilazione</label>
                            <input type="date" id="dataCompilazione" name="dataCompilazione">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome<span class="required">*</span></label>
                            <input type="text" id="nome" name="nome" required>
                        </div>

                        <div class="form-group">
                            <label for="cognome">Cognome<span class="required">*</span></label>
                            <input type="text" id="cognome" name="cognome" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data di Nascita<span class="required">*</span></label>
                            <div class="date-input-group">
                                <input type="number" id="giorno" name="giorno" placeholder="GG" min="1" max="31" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="mese" name="mese" placeholder="MM" min="1" max="12" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="anno" name="anno" placeholder="AAAA" min="1900" max="2025" maxlength="4" required>
                            </div>
                            <input type="hidden" id="dataNascita" name="dataNascita">
                        </div>

                        <div class="form-group">
                            <label>Et√†</label>
                            <div class="age-display empty" id="ageDisplay">
                                üéÇ - anni
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="indirizzoResidenza">Indirizzo Residenza</label>
                            <input type="text" id="indirizzoResidenza" name="indirizzoResidenza">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="comune">Comune di Residenza<span class="required">*</span></label>
                            <select id="comune" name="comune" required>
                                <option value="">Seleziona il comune...</option>
                                <option value="Novi Ligure">üèõÔ∏è Novi Ligure (19)</option>
                                <option value="Arquata Scrivia">üèõÔ∏è Arquata Scrivia (8)</option>
                                <option value="Serravalle Scrivia">üèõÔ∏è Serravalle Scrivia (9)</option>
                                <option value="Gavi">üèõÔ∏è Gavi (5)</option>
                                <option value="Basaluzzo">üèõÔ∏è Basaluzzo (1)</option>
                                <option value="Bosio">üèõÔ∏è Bosio (1)</option>
                                <option value="Cassano Spinola">üèõÔ∏è Cassano Spinola (1)</option>
                                <option value="Fresonara">üèõÔ∏è Fresonara (1)</option>
                                <option value="Pozzolo Formigaro">üèõÔ∏è Pozzolo Formigaro (1)</option>
                                <option value="Stazzano">üèõÔ∏è Stazzano (1)</option>
                                <option value="Tassarolo">üèõÔ∏è Tassarolo (1)</option>
                                <option value="Vignole Borbera">üèõÔ∏è Vignole Borbera (1)</option>
                                <option value="Voltaggio">üèõÔ∏è Voltaggio (1)</option>
                                <option value="Albera Ligure">üèõÔ∏è Albera Ligure (0)</option>
                                <option value="Borghetto Di Borbera">üèõÔ∏è Borghetto Di Borbera (0)</option>
                                <option value="Cabella Ligure">üèõÔ∏è Cabella Ligure (0)</option>
                                <option value="Cantalupo Ligure">üèõÔ∏è Cantalupo Ligure (0)</option>
                                <option value="Capriata D'Orba">üèõÔ∏è Capriata D'Orba (0)</option>
                                <option value="Carrega Ligure">üèõÔ∏è Carrega Ligure (0)</option>
                                <option value="Carrosio">üèõÔ∏è Carrosio (0)</option>
                                <option value="Fraconalto">üèõÔ∏è Fraconalto (0)</option>
                                <option value="Francavilla Bisio">üèõÔ∏è Francavilla Bisio (0)</option>
                                <option value="Grondona">üèõÔ∏è Grondona (0)</option>
                                <option value="Mongiardino Ligure">üèõÔ∏è Mongiardino Ligure (0)</option>
                                <option value="Parodi Ligure">üèõÔ∏è Parodi Ligure (0)</option>
                                <option value="Pasturana">üèõÔ∏è Pasturana (0)</option>
                                <option value="Roccaforte Ligure">üèõÔ∏è Roccaforte Ligure (0)</option>
                                <option value="Rocchetta Ligure">üèõÔ∏è Rocchetta Ligure (0)</option>
                                <option value="San Cristoforo">üèõÔ∏è San Cristoforo (0)</option>
                                <option value="Sardigliano">üèõÔ∏è Sardigliano (0)</option>

                                </select>
                        </div>

                        <div class="form-group">
                            <label for="telFisso">Telefono Fisso</label>
                            <input type="tel" id="telFisso" name="telFisso" placeholder="0143...">
                        </div>

                        <div class="form-group">
                            <label for="cellulare">Cellulare</label>
                            <input type="tel" id="cellulare" name="cellulare" placeholder="333...">
                        </div>
                    </div>
                </div>

                <!-- CAREGIVER -->
                <div class="section">
                    <h2 class="section-title">üë• Caregiver</h2>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver B</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverB_nome">Nome</label>
                                <input type="text" id="caregiverB_nome" name="caregiverB_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cognome">Cognome</label>
                                <input type="text" id="caregiverB_cognome" name="caregiverB_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_parentela">Parentela</label>
                                <input type="text" id="caregiverB_parentela" name="caregiverB_parentela" placeholder="Es: Figlio/a">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_email">Email</label>
                                <input type="email" id="caregiverB_email" name="caregiverB_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverB_cellulare" name="caregiverB_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_chiavi">Chiavi</label>
                                <select id="caregiverB_chiavi" name="caregiverB_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver C</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverC_nome">Nome</label>
                                <input type="text" id="caregiverC_nome" name="caregiverC_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cognome">Cognome</label>
                                <input type="text" id="caregiverC_cognome" name="caregiverC_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_parentela">Parentela</label>
                                <input type="text" id="caregiverC_parentela" name="caregiverC_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_email">Email</label>
                                <input type="email" id="caregiverC_email" name="caregiverC_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverC_cellulare" name="caregiverC_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_chiavi">Chiavi</label>
                                <select id="caregiverC_chiavi" name="caregiverC_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver D</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverD_nome">Nome</label>
                                <input type="text" id="caregiverD_nome" name="caregiverD_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cognome">Cognome</label>
                                <input type="text" id="caregiverD_cognome" name="caregiverD_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_parentela">Parentela</label>
                                <input type="text" id="caregiverD_parentela" name="caregiverD_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_email">Email</label>
                                <input type="email" id="caregiverD_email" name="caregiverD_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverD_cellulare" name="caregiverD_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_chiavi">Chiavi</label>
                                <select id="caregiverD_chiavi" name="caregiverD_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="scalettaContatti">Scaletta Contatti C.O.</label>
                        <textarea id="scalettaContatti" name="scalettaContatti" placeholder="Ordine di priorit√† per contattare i caregiver..."></textarea>
                    </div>
                </div>

                <!-- ALTRI DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title">üìù Altri Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="natoA">Nato a</label>
                            <input type="text" id="natoA" name="natoA">
                        </div>
                        <div class="form-group">
                            <label for="provinciaNascita">Provincia</label>
                            <input type="text" id="provinciaNascita" name="provinciaNascita" maxlength="2" placeholder="TP">
                        </div>
                        <div class="form-group">
                            <label for="codiceFiscale">Codice Fiscale</label>
                            <input type="text" id="codiceFiscale" name="codiceFiscale" maxlength="16" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoAbitazione">Tipo Abitazione</label>
                            <select id="tipoAbitazione" name="tipoAbitazione">
                                <option value="">Seleziona...</option>
                                <option value="Appartamento">üè¢ Appartamento</option>
                                <option value="Casa">üè† Casa Indipendente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="piano">Piano</label>
                            <input type="number" id="piano" name="piano" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="ascensore">Ascensore</label>
                            <select id="ascensore" name="ascensore">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sesso">Sesso</label>
                            <select id="sesso" name="sesso">
                                <option value="">-</option>
                                <option value="M">üë® M</option>
                                <option value="F">üë© F</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="peso">Peso (kg)</label>
                            <input type="number" id="peso" name="peso" min="0" placeholder="70">
                        </div>
                        <div class="form-group">
                            <label for="altezza">Altezza (cm)</label>
                            <input type="number" id="altezza" name="altezza" min="0" placeholder="170">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="patologie">Patologie e Fragilit√†</label>
                            <textarea id="patologie" name="patologie" placeholder="Elencare patologie croniche e condizioni di fragilit√†..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="farmaci">Farmaci e Orari</label>
                            <textarea id="farmaci" name="farmaci" placeholder="Es: ore 08:00 Cardioaspirin 100mg, ore 20:00 Eutirox 50mcg..."></textarea>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="freqCardiacaMin">Freq. Cardiaca Min (bpm)</label>
                            <input type="number" id="freqCardiacaMin" name="freqCardiacaMin" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label for="freqCardiacaMax">Freq. Cardiaca Max (bpm)</label>
                            <input type="number" id="freqCardiacaMax" name="freqCardiacaMax" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="saturazioneMin">Saturazione Min (%)</label>
                            <input type="number" id="saturazioneMin" name="saturazioneMin" min="70" max="100" placeholder="95">
                        </div>
                    </div>
                </div>

                <!-- AUSILI ED ECG -->
                <div class="section">
                    <h2 class="section-title">üîß Sensore ECG</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="sensoreEcg">Sensore ECG</label>
                            <select id="sensoreEcg" name="sensoreEcg">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                        <!-- Campi nascosti per mantenere compatibilit√† Google Sheet -->
                        <input type="hidden" id="poltrone" name="poltrone" value="">
                        <input type="hidden" id="sensoreLuce" name="sensoreLuce" value="">
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="note">Note Aggiuntive</label>
                            <textarea id="note" name="note" placeholder="Eventuali informazioni aggiuntive rilevanti..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ALTRI CONTATTI -->
                <div class="section">
                    <h2 class="section-title">üìû Altri Contatti</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="assSocialeNome">Nominativo Ass. Sociale</label>
                            <input type="text" id="assSocialeNome" name="assSocialeNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="assSocialeCellulare">N¬∞ Cellulare Ass. Sociale</label>
                            <input type="tel" id="assSocialeCellulare" name="assSocialeCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ossNome">Nominativo OSS</label>
                            <input type="text" id="ossNome" name="ossNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="ossCellulare">N¬∞ Cellulare OSS</label>
                            <input type="tel" id="ossCellulare" name="ossCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="infermiereNome">Nominativo Infermiere</label>
                            <input type="text" id="infermiereNome" name="infermiereNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="infermiereCellulare">N¬∞ Cellulare Infermiere</label>
                            <input type="tel" id="infermiereCellulare" name="infermiereCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mmgNome">Nominativo MMG</label>
                            <input type="text" id="mmgNome" name="mmgNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="mmgCellulare">N¬∞ Cellulare MMG</label>
                            <input type="tel" id="mmgCellulare" name="mmgCellulare" placeholder="3331234567">
                        </div>
                    </div>
                </div>

                <!-- PIANIFICAZIONE INSTALLAZIONE -->
                <div class="section">
                    <h2 class="section-title">üìÖ Pianificazione Installazione</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="meseInstallazionePrevisto">Mese Install. Dispositivo</label>
                            <select id="meseInstallazionePrevisto" name="meseInstallazionePrevisto">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="meseInstallazioneSensoreEcg">Mese Install. Sensore ECG</label>
                            <select id="meseInstallazioneSensoreEcg" name="meseInstallazioneSensoreEcg">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                        <!-- Campi nascosti per compatibilit√† Google Sheet -->
                        <input type="hidden" id="meseInstallazionePoltrona" name="meseInstallazionePoltrona" value="">
                        <input type="hidden" id="meseInstallazioneSensoreLuce" name="meseInstallazioneSensoreLuce" value="">
                    </div>

                    <div class="form-group full-width" style="margin-top: 15px;">
                        <label for="notePianificazione">Note Pianificazione</label>
                        <textarea id="notePianificazione" name="notePianificazione" placeholder="Eventuali note sulla pianificazione installazione..."></textarea>
                    </div>
                </div>

                <!-- INSTALLAZIONE -->
                <div class="section">
                    <h2 class="section-title">‚öôÔ∏è Installazione</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="serialeDispositivo">Seriale Dispositivo</label>
                            <input type="text" id="serialeDispositivo" name="serialeDispositivo" placeholder="SN...">
                        </div>
                        <div class="form-group">
                            <label for="installazioneSensoreEcg">Sensore ECG Installato</label>
                            <select id="installazioneSensoreEcg" name="installazioneSensoreEcg">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <!-- Campi nascosti per compatibilit√† Google Sheet -->
                        <input type="hidden" id="installazionePoltrona" name="installazionePoltrona" value="">
                        <input type="hidden" id="installazioneSensoreLuce" name="installazioneSensoreLuce" value="">
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">
                        üíæ SALVA
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="nuovaSchedaConConferma()">
                        ‚ú® Nuova Scheda
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Caricamento...</p>
        </div>
    </div>
    
    <script>
        // ========================================
        // ‚úÖ CONFIGURAZIONE GLOBALE
        // ========================================
        const DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbyfAcAGaiJD2upzZPKJjnsHQq6gwdY3jPBamo9Bnv41I4v_F0wJ9cKNDtCeX02ggQLSuQ/exec';  // ‚úÖ URL CONFIGURATO - Backend CSP Novi Ligure
        
        // ‚úÖ FIX v3.5.2: Traccia se stiamo modificando una scheda esistente
        let SCHEDA_IN_MODIFICA = false;
        
        let schedeCache = [];
        let installatiCache = [];
        let pianificatiCache = [];
        
        let OBIETTIVI_COMUNI = {
            '': 46,
            '': 19,
            'Vald': 8,
            '': 8,
            '': 7,
            '': 4,
            '': 3,
            '': 3,
            '': 2
        };
        
        // ========================================
        // ‚úÖ FIX CORS: Caricamento obiettivi dal backend
        // ========================================
        async function caricaObiettiviDalServer() {
            try {
                console.log('üìä Caricamento obiettivi dal server...');
                const response = await fetch(DEPLOY_URL + '?action=getObiettivi', {
                    method: 'GET',
                    mode: 'cors' // ‚úÖ Prova prima CORS
                });
                const data = await response.json();
                
                if (data.success && data.obiettivi) {
                    OBIETTIVI_COMUNI = data.obiettivi;
                    console.log('‚úÖ Obiettivi caricati dal server:', OBIETTIVI_COMUNI);
                    aggiornaDashboard();
                    renderConfigObiettivi();
                } else {
                    console.log('‚ö†Ô∏è Usando obiettivi default');
                }
            } catch(e) {
                console.log('‚ö†Ô∏è Errore caricamento obiettivi, uso default:', e);
            }
        }
        
        // ========================================
        // INIZIALIZZAZIONE
        // ========================================
        window.addEventListener('DOMContentLoaded', function() {
            setupPianificazioneListeners();
            impostaDataOggi();
            caricaObiettiviDalServer();
            caricaSchede();
            setupDateInputs();
        });
        
        // ========================================
        // GESTIONE TAB
        // ========================================
        function switchTab(tabName, clickEvent) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            // ‚úÖ FIX v3.5.4: Verifica che event esista prima di usare event.target
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            }
            
            if (tabName === 'dashboard') {
                aggiornaDashboard();
            } else if (tabName === 'installati') {
                mostraInstallati();
            } else if (tabName === 'pianificati') {
                mostraPianificati();
            }
        }
        
        // ========================================
        // ‚úÖ FIX CORS: Caricamento dati
        // ========================================
        function caricaSchede() {
            mostraLoading('Caricamento dati...');
            
            fetch(DEPLOY_URL, {
                method: 'GET',
                mode: 'cors' // ‚úÖ Prova CORS
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üìä Dati ricevuti:', data);
                    if (data.success) {
                        schedeCache = data.schede || [];
                        
                        installatiCache = schedeCache.filter(s => {
                            const haImei = s.IMEI && String(s.IMEI).trim() !== '';
                            const haSeriale = s.serialeDispositivo && String(s.serialeDispositivo).trim() !== '';
                            return haImei || haSeriale;
                        });
                        
                        pianificatiCache = schedeCache.filter(s => 
                            s.meseInstallazionePrevisto && 
                            s.meseInstallazionePrevisto !== 'Non pianificato' &&
                            s.meseInstallazionePrevisto !== '' &&
                            (!s.IMEI || String(s.IMEI).trim() === '') &&
                            (!s.serialeDispositivo || String(s.serialeDispositivo).trim() === '')
                        );
                        
                        console.log('‚úÖ Schede:', schedeCache.length);
                        console.log('‚úÖ Installati:', installatiCache.length);
                        console.log('‚úÖ Pianificati:', pianificatiCache.length);
                        
                        aggiornaDashboard();
                        nascondiLoading();
                        mostraMessaggio('success', `‚úÖ ${schedeCache.length} schede caricate`);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Errore caricamento:', error);
                    nascondiLoading();
                    mostraMessaggio('error', '‚ùå Errore caricamento dati. Verifica la connessione e l\'URL Google Apps Script.');
                });
        }
        
        // ========================================
        // DASHBOARD
        // ========================================
        function aggiornaDashboard() {
            if (schedeCache.length === 0) return;
            
            const installati = installatiCache.length;
            const pianificati = pianificatiCache.length;
            const comuni = new Set(schedeCache.map(s => s.comune).filter(c => c)).size;
            const totale = schedeCache.length;
            
            // ‚úÖ FIX CSP NOVI: Calcolo dinamico su totalObiettivo (50) invece di 100 hardcoded
            const totalObiettivo = Object.values(OBIETTIVI_COMUNI).reduce((sum, val) => sum + (val || 0), 0);
            const progresso = totalObiettivo > 0 ? Math.round((installati / totalObiettivo) * 100) : 0;
            const rimanenti = Math.max(0, totalObiettivo - installati);
            
            document.getElementById('stat-totale').textContent = totale;
            document.getElementById('stat-installati').textContent = installati;
            document.getElementById('stat-pianificati').textContent = pianificati;
            document.getElementById('stat-comuni').textContent = comuni;
            document.getElementById('dashboard-progress').textContent = progresso + '%';
            document.getElementById('dashboard-remaining').textContent = rimanenti;
            document.getElementById('progress-bar').style.width = progresso + '%';
            
            // ‚úÖ FIX CSP NOVI: Aggiorna anche l'obiettivo totale dinamicamente
            if (document.getElementById('obiettivo-totale')) {
                document.getElementById('obiettivo-totale').textContent = totalObiettivo;
            }
            
            aggiornaTabellaComuni();
        }
        
        // ========================================
        // TABELLA COMUNI
        // ========================================
        function aggiornaTabellaComuni() {
            // ‚úÖ FIX CSP NOVI: Usa i comuni da OBIETTIVI_COMUNI invece di array hardcoded
            const COMUNI_DISTRETTO = Object.keys(OBIETTIVI_COMUNI);
            
            const conteggioComuni = {};
            const installatiComuni = {};
            
            COMUNI_DISTRETTO.forEach(comune => {
                conteggioComuni[comune] = 0;
                installatiComuni[comune] = 0;
            });
            
            // üîß FIX: Aggiungi contatore per comuni non validi
            conteggioComuni['_ALTRI'] = 0;
            installatiComuni['_ALTRI'] = 0;
            
            schedeCache.forEach(scheda => {
                const comuneValido = scheda.comune && COMUNI_DISTRETTO.includes(scheda.comune);
                const comuneTarget = comuneValido ? scheda.comune : '_ALTRI';
                
                conteggioComuni[comuneTarget]++;
                
                const haImei = scheda.IMEI && String(scheda.IMEI).trim() !== '' && scheda.IMEI !== 'Non specificato';
                const haSeriale = scheda.serialeDispositivo && String(scheda.serialeDispositivo).trim() !== '' && scheda.serialeDispositivo !== 'Non specificato';
                if (haImei || haSeriale) {
                    installatiComuni[comuneTarget]++;
                }
            });
            
            // ‚úÖ FIX: Crea copia array prima di sort per non modificare l'originale
            const comuniOrdinati = [...COMUNI_DISTRETTO].sort((a, b) => OBIETTIVI_COMUNI[b] - OBIETTIVI_COMUNI[a]);
            
            let html = '';
            comuniOrdinati.forEach(comune => {
                const count = conteggioComuni[comune] || 0;
                const obiettivo = OBIETTIVI_COMUNI[comune];
                const percentuale = obiettivo > 0 ? Math.round((count / obiettivo) * 100) : 0;
                const mancanti = Math.max(0, obiettivo - count);
                
                let coloreBarra = '#667eea';
                let bgColor = '';
                if (percentuale >= 100) {
                    coloreBarra = '#28a745';
                    bgColor = 'background: #d4edda;';
                } else if (percentuale >= 75) {
                    coloreBarra = '#ffc107';
                    bgColor = 'background: #fff3cd;';
                } else if (percentuale >= 50) {
                    coloreBarra = '#fd7e14';
                } else if (percentuale > 0) {
                    coloreBarra = '#dc3545';
                }
                
                const installati = installatiComuni[comune] || 0;
                
                html += `
                    <tr style="${bgColor}">
                        <td><strong>${comune}</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 16px; color: #667eea;">${count}</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 18px; color: #28a745;">${installati}</strong></td>
                        <td style="text-align: center;"><strong style="color: #764ba2;">${obiettivo}</strong></td>
                        <td style="text-align: center;"><strong style="color: ${coloreBarra};">${percentuale}%</strong></td>
                        <td>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${Math.min(percentuale, 100)}%; background: ${coloreBarra};"></div>
                            </div>
                        </td>
                        <td style="text-align: center;"><span style="color: ${mancanti > 0 ? '#dc3545' : '#28a745'};">${mancanti}</span></td>
                    </tr>
                `;
            // üîß FIX: Aggiungi riga "Altri" se ci sono assistiti non classificati
            });
            
            // üîß FIX: Aggiungi riga "Altri" se ci sono assistiti non classificati
            if (conteggioComuni['_ALTRI'] > 0) {
                const countAltri = conteggioComuni['_ALTRI'] || 0;
                const installatiAltri = installatiComuni['_ALTRI'] || 0;
                
                html += `
                    <tr style="background: #fff3cd;">
                        <td><strong style="color: #856404;">‚ö†Ô∏è Altri / Non Specificato</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 16px; color: #856404;">${countAltri}</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 18px; color: #856404;">${installatiAltri}</strong></td>
                        <td style="text-align: center;"><strong style="color: #999;">-</strong></td>
                        <td style="text-align: center;"><strong style="color: #999;">-</strong></td>
                        <td><div class="progress-mini"><div class="progress-mini-fill" style="width: 0%; background: #999;"></div></div></td>
                        <td style="text-align: center;"><strong style="color: #999;">-</strong></td>
                    </tr>
                `;
            }
            
            let totalAssistiti = 0;
            let totalInstallati = 0;
            let totalObiettivo = 0;
            let totalMancanti = 0;
            
            comuniOrdinati.forEach(comune => {
                totalAssistiti += conteggioComuni[comune] || 0;
                totalInstallati += installatiComuni[comune] || 0;
                totalObiettivo += OBIETTIVI_COMUNI[comune] || 0;
                totalMancanti += Math.max(0, OBIETTIVI_COMUNI[comune] - conteggioComuni[comune]);
            });
            
            // üîß FIX: Includi "Altri" nel totale
            totalAssistiti += conteggioComuni['_ALTRI'] || 0;
            totalInstallati += installatiComuni['_ALTRI'] || 0;
            
            const totalPercentuale = totalObiettivo > 0 ? Math.round((totalAssistiti / totalObiettivo) * 100) : 0;
            
            html += `
                <tr style="background: #e9ecef; font-weight: bold; border-top: 3px solid #667eea;">
                    <td><strong>üìä TOTALE</strong></td>
                    <td style="text-align: center;"><strong style="font-size: 18px; color: #667eea;">${totalAssistiti}</strong></td>
                    <td style="text-align: center;"><strong style="font-size: 18px; color: #28a745;">${totalInstallati}</strong></td>
                    <td style="text-align: center;"><strong style="color: #764ba2;">${totalObiettivo}</strong></td>
                    <td style="text-align: center;"><strong style="color: ${totalPercentuale >= 100 ? '#28a745' : totalPercentuale >= 75 ? '#ffc107' : '#dc3545'};">${totalPercentuale}%</strong></td>
                    <td>
                        <div class="progress-mini">
                            <div class="progress-mini-fill" style="width: ${Math.min(totalPercentuale, 100)}%; background: ${totalPercentuale >= 100 ? '#28a745' : totalPercentuale >= 75 ? '#ffc107' : '#dc3545'};"></div>
                        </div>
                    </td>
                    <td style="text-align: center;"><strong style="color: ${totalMancanti > 0 ? '#dc3545' : '#28a745'};">${totalMancanti}</strong></td>
                </tr>
            `;
            
            document.getElementById('comuni-table-body').innerHTML = html;
        }
        
        // ========================================
        // TAB INSTALLATI
        // ========================================
        function mostraInstallati() {
            filtraInstallati();
        }
        
        function formatMeseInstallazione(dataString) {
            if (!dataString || dataString === 'Non specificato' || dataString === 'Non pianificato') {
                return 'Non specificato';
            }
            
            if (typeof dataString === 'string' && /^[A-Za-z]+ \d{4}$/.test(dataString)) {
                return dataString;
            }
            
            try {
                const data = new Date(dataString);
                if (isNaN(data.getTime())) return 'Non specificato';
                
                const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                
                return `${mesi[data.getMonth()]} ${data.getFullYear()}`;
            } catch(e) {
                return 'Non specificato';
            }
        }
        
        function filtraInstallati() {
            const filtroComune = document.getElementById('filter-comune-installati').value;
            
            let lista = installatiCache;
            if (filtroComune) {
                lista = installatiCache.filter(s => s.comune === filtroComune);
            }
            
            document.getElementById('count-installati').textContent = lista.length;
            
            if (lista.length === 0) {
                document.getElementById('lista-installati-full').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>Nessun dispositivo installato${filtroComune ? ' per ' + filtroComune : ''}</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Seriale (IMEI)</th><th>Mese Installazione</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            lista.forEach(s => {
                const seriale = s.IMEI || s.serialeDispositivo || '-';
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td><code>${seriale}</code></td>
                    <td>${formatMeseInstallazione(s.meseInstallazionePrevisto)}</td>
                    <td><span class="badge badge-success">‚úÖ Installato</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('lista-installati-full').innerHTML = html;
        }
        
        // ========================================
        // TAB PIANIFICATI
        // ========================================
        function mostraPianificati() {
            filtraPianificati();
        }
        
        function filtraPianificati() {
            const filtroMese = document.getElementById('filter-mese-pianificati').value;
            const filtroComune = document.getElementById('filter-comune-pianificati').value;
            
            let lista = pianificatiCache;
            
            if (filtroMese) {
                lista = lista.filter(s => s.meseInstallazionePrevisto === filtroMese);
            }
            
            if (filtroComune) {
                lista = lista.filter(s => s.comune === filtroComune);
            }
            
            document.getElementById('count-pianificati').textContent = lista.length;
            
            if (lista.length === 0) {
                document.getElementById('lista-pianificati-full').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Nessuna installazione pianificata${filtroMese ? ' per ' + filtroMese : ''}${filtroComune ? ' a ' + filtroComune : ''}</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Mese Previsto</th><th>Note</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            lista.forEach(s => {
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td>üìÖ ${formatMeseInstallazione(s.meseInstallazionePrevisto)}</td>
                    <td>${s.notePianificazione || '-'}</td>
                    <td><span class="badge badge-info">üìÖ Pianificato</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('lista-pianificati-full').innerHTML = html;
        }
        
        // ========================================
        // ‚úÖ FIX: RICERCA con conversione a stringa
        // ========================================
        function mostraTutteLeSchede() {
            switchTab('ricerca');
            document.getElementById('searchInput').value = '';
            
            const resultsDiv = document.getElementById('search-results');
            
            if (schedeCache.length === 0) {
                resultsDiv.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Nessuna scheda disponibile</p>';
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Data Nascita</th><th>Et√†</th><th>Cellulare</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            schedeCache.forEach(s => {
                const haImei = s.IMEI && String(s.IMEI).trim() !== '';
                const haSeriale = s.serialeDispositivo && String(s.serialeDispositivo).trim() !== '';
                const installato = haImei || haSeriale;
                const pianificato = s.meseInstallazionePrevisto && s.meseInstallazionePrevisto !== 'Non pianificato' && s.meseInstallazionePrevisto !== '';
                
                let stato = '‚ö†Ô∏è Non pianificato';
                let badgeClass = 'badge-warning';
                if (installato) {
                    stato = '‚úÖ Installato';
                    badgeClass = 'badge-success';
                } else if (pianificato) {
                    stato = 'üìÖ Pianificato';
                    badgeClass = 'badge-info';
                }
                
                // ‚úÖ FIX v3.6.14: Parser manuale DD/MM/YY ‚Üí DD/MM/YYYY per visualizzazione
                // üîß BUGFIX: Per assistiti anziani, TUTTI gli anni a 2 cifre sono nel 1900
                let dataFormattata = '-';
                if (s.dataNascita) {
                    const match = s.dataNascita.match(/^(\d{2})\/(\d{2})\/(\d{2})$/);
                    if (match) {
                        const [_, giorno, mese, anno] = match;
                        // Per assistenza anziani: tutti gli anni a 2 cifre sono nel 1900
                        const annoCompleto = `19${anno}`;
                        dataFormattata = `${giorno}/${mese}/${annoCompleto}`;
                    } else {
                        dataFormattata = s.dataNascita;
                    }
                }
                
                const eta = s.eta || 'N/A';  // ‚úÖ Usa et√† dal backend (gi√† calcolata correttamente)
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})' style="cursor: pointer;">
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td>${dataFormattata}</td>
                    <td>${eta}</td>
                    <td>${s.cellulare || '-'}</td>
                    <td><span class="badge ${badgeClass}">${stato}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        function cercaAssistito() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query === '') {
                resultsDiv.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Digita per cercare un assistito</p>';
                return;
            }
            
            // ‚úÖ FIX: Converti tutti i campi a stringa prima di toLowerCase()
            const risultati = schedeCache.filter(s => {
                const nome = String(s.nome || '').toLowerCase();
                const cognome = String(s.cognome || '').toLowerCase();
                const scheda = String(s.numeroScheda || '').toLowerCase();
                const comune = String(s.comune || '').toLowerCase();
                
                return nome.includes(query) || cognome.includes(query) || scheda.includes(query) || comune.includes(query);
            });
            
            if (risultati.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><p>Nessun assistito trovato</p></div>';
                return;
            }
            
            let html = '';
            risultati.forEach(s => {
                const haImei = s.IMEI && String(s.IMEI).trim() !== '';
                const haSeriale = s.serialeDispositivo && String(s.serialeDispositivo).trim() !== '';
                const installato = haImei || haSeriale;
                const pianificato = s.meseInstallazionePrevisto && s.meseInstallazionePrevisto !== 'Non pianificato' && s.meseInstallazionePrevisto !== '';
                
                let badges = '';
                if (installato) {
                    badges += `<span class="badge badge-success">‚úÖ Installato</span>`;
                }
                if (pianificato) {
                    badges += `<span class="badge badge-info">üìÖ ${formatMeseInstallazione(s.meseInstallazionePrevisto)}</span>`;
                }
                if (!installato && !pianificato) {
                    badges += `<span class="badge badge-warning">‚ö†Ô∏è Non pianificato</span>`;
                }
                
                const seriale = s.IMEI || s.serialeDispositivo;
                
                html += `
                    <div class="assistito-card" onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                        <div class="assistito-info">
                            <div class="assistito-nome">${s.nome || ''} ${s.cognome || ''}</div>
                            <div class="assistito-dettagli">
                                üìã Scheda: <strong>${s.numeroScheda || '-'}</strong> | 
                                üìç ${s.comune || '-'} | 
                                üéÇ ${s.dataNascita || '-'}
                            </div>
                            ${installato ? `<div class="assistito-dettagli" style="margin-top:5px">üì± Seriale: <code>${seriale}</code></div>` : ''}
                        </div>
                        <div class="assistito-badges">
                            ${badges}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function mostraDettaglioAssistito(scheda) {
            // ‚úÖ FIX v3.5.2: Imposta flag di modifica
            SCHEDA_IN_MODIFICA = true;
            caricaSchedaCompleta(scheda);
            switchTab('nuova');
            console.log('üìù Modalit√† MODIFICA attivata per scheda:', scheda.numeroScheda);
        }
        
        function caricaSchedaCompleta(scheda) {
            document.getElementById('numeroScheda').value = scheda.numeroScheda || '';
            document.getElementById('nome').value = scheda.nome || '';
            document.getElementById('cognome').value = scheda.cognome || '';
            
            if (scheda.dataNascita) {
                // ‚úÖ FIX v3.6.3: Parser manuale per formato DD/MM/YY
                let giorno, mese, anno;
                
                if (typeof scheda.dataNascita === 'string' && scheda.dataNascita.includes('/')) {
                    // Formato DD/MM/YY o DD/MM/YYYY
                    const parti = scheda.dataNascita.split('/');
                    if (parti.length === 3) {
                        giorno = parseInt(parti[0]);
                        mese = parseInt(parti[1]);
                        anno = parseInt(parti[2]);
                        
                        // üîß BUGFIX v3.6.14: Converti anno 2 cifre in 4 cifre
                        // Per assistenza anziani: tutti gli anni a 2 cifre sono nel 1900
                        if (anno < 100) {
                            anno = 1900 + anno;
                        }
                    }
                } else {
                    // Fallback: usa Date() standard
                    const data = new Date(scheda.dataNascita);
                    giorno = data.getDate();
                    mese = data.getMonth() + 1;
                    anno = data.getFullYear();
                }
                
                document.getElementById('giorno').value = giorno || '';
                document.getElementById('mese').value = mese || '';
                document.getElementById('anno').value = anno || '';
                calcolaEta();
            }
            
            document.getElementById('indirizzoResidenza').value = scheda.indirizzoResidenza || '';
            document.getElementById('comune').value = scheda.comune || '';
            document.getElementById('telFisso').value = scheda.telFisso || '';
            document.getElementById('cellulare').value = scheda.cellulare || '';
            
            document.getElementById('caregiverB_nome').value = scheda.caregiverB_nome || '';
            document.getElementById('caregiverB_cognome').value = scheda.caregiverB_cognome || '';
            document.getElementById('caregiverB_parentela').value = scheda.caregiverB_parentela || '';
            document.getElementById('caregiverB_email').value = scheda.caregiverB_email || '';
            document.getElementById('caregiverB_cellulare').value = scheda.caregiverB_cellulare || '';
            document.getElementById('caregiverB_chiavi').value = scheda.caregiverB_chiavi || '';
            
            document.getElementById('caregiverC_nome').value = scheda.caregiverC_nome || '';
            document.getElementById('caregiverC_cognome').value = scheda.caregiverC_cognome || '';
            document.getElementById('caregiverC_parentela').value = scheda.caregiverC_parentela || '';
            document.getElementById('caregiverC_email').value = scheda.caregiverC_email || '';
            document.getElementById('caregiverC_cellulare').value = scheda.caregiverC_cellulare || '';
            document.getElementById('caregiverC_chiavi').value = scheda.caregiverC_chiavi || '';
            
            document.getElementById('caregiverD_nome').value = scheda.caregiverD_nome || '';
            document.getElementById('caregiverD_cognome').value = scheda.caregiverD_cognome || '';
            document.getElementById('caregiverD_parentela').value = scheda.caregiverD_parentela || '';
            document.getElementById('caregiverD_email').value = scheda.caregiverD_email || '';
            document.getElementById('caregiverD_cellulare').value = scheda.caregiverD_cellulare || '';
            document.getElementById('caregiverD_chiavi').value = scheda.caregiverD_chiavi || '';
            
            document.getElementById('scalettaContatti').value = scheda.scalettaContatti || '';
            document.getElementById('assSocialeNome').value = scheda.assSocialeNome || '';
            document.getElementById('assSocialeCellulare').value = scheda.assSocialeCellulare || '';
            document.getElementById('ossNome').value = scheda.ossNome || '';
            document.getElementById('ossCellulare').value = scheda.ossCellulare || '';
            document.getElementById('infermiereNome').value = scheda.infermiereNome || '';
            document.getElementById('infermiereCellulare').value = scheda.infermiereCellulare || '';
            document.getElementById('mmgNome').value = scheda.mmgNome || '';
            document.getElementById('mmgCellulare').value = scheda.mmgCellulare || '';
            
            document.getElementById('natoA').value = scheda.natoA || '';
            document.getElementById('provinciaNascita').value = scheda.provinciaNascita || '';
            document.getElementById('codiceFiscale').value = scheda.codiceFiscale || '';
            
            document.getElementById('tipoAbitazione').value = scheda.tipoAbitazione || '';
            document.getElementById('piano').value = scheda.piano || '';
            document.getElementById('ascensore').value = scheda.ascensore || '';
            
            document.getElementById('sesso').value = scheda.sesso || '';
            document.getElementById('peso').value = scheda.peso || '';
            document.getElementById('altezza').value = scheda.altezza || '';
            document.getElementById('patologie').value = scheda.patologie || '';
            document.getElementById('farmaci').value = scheda.farmaci || '';
            document.getElementById('freqCardiacaMin').value = scheda.freqCardiacaMin || '';
            document.getElementById('freqCardiacaMax').value = scheda.freqCardiacaMax || '';
            document.getElementById('saturazioneMin').value = scheda.saturazioneMin || '';
            
            document.getElementById('serialeDispositivo').value = scheda.IMEI || scheda.serialeDispositivo || '';
            
            // ‚úÖ FIX v3.6.7: Conversione data compilazione da DD/MM/YY a YYYY-MM-DD
            if (scheda.dataCompilazione) {
                const match = scheda.dataCompilazione.match(/(\d{2})\/(\d{2})\/(\d{2})/);
                if (match) {
                    const [_, giorno, mese, anno] = match;
                    const annoCompleto = parseInt(anno) <= 30 ? `20${anno}` : `19${anno}`;
                    document.getElementById('dataCompilazione').value = `${annoCompleto}-${mese}-${giorno}`;
                } else {
                    document.getElementById('dataCompilazione').value = '';
                }
            } else {
                document.getElementById('dataCompilazione').value = '';
            }
            
            document.getElementById('poltrone').value = scheda.poltrone || '';
            document.getElementById('sensoreLuce').value = scheda.sensoreLuce || '';
            document.getElementById('sensoreEcg').value = scheda.sensoreEcg || '';
            document.getElementById('note').value = scheda.note || '';
            document.getElementById('installazionePoltrona').value = scheda.installazionePoltrona || '';
            document.getElementById('installazioneSensoreLuce').value = scheda.installazioneSensoreLuce || '';
            document.getElementById('installazioneSensoreEcg').value = scheda.installazioneSensoreEcg || '';
            
            document.getElementById('meseInstallazionePrevisto').value = scheda.meseInstallazionePrevisto || '';
            document.getElementById('notePianificazione').value = scheda.notePianificazione || '';
            document.getElementById('meseInstallazionePoltrona').value = scheda.meseInstallazionePoltrona || '';
            document.getElementById('meseInstallazioneSensoreLuce').value = scheda.meseInstallazioneSensoreLuce || '';
            document.getElementById('meseInstallazioneSensoreEcg').value = scheda.meseInstallazioneSensoreEcg || '';
        }
        
        // ========================================
        // FORM GESTIONE
        // ========================================
        function setupDateInputs() {
            const giorno = document.getElementById('giorno');
            const mese = document.getElementById('mese');
            const anno = document.getElementById('anno');
            
            giorno.addEventListener('input', () => { if (giorno.value.length >= 2) mese.focus(); calcolaEta(); });
            mese.addEventListener('input', () => { if (mese.value.length >= 2) anno.focus(); calcolaEta(); });
            anno.addEventListener('input', calcolaEta);
        }
        
        function calcolaEta() {
            const g = parseInt(document.getElementById('giorno').value);
            const m = parseInt(document.getElementById('mese').value);
            const a = parseInt(document.getElementById('anno').value);
            const display = document.getElementById('ageDisplay');
            
            if (g && m && a && g <= 31 && m <= 12 && a >= 1900 && a <= 2025) {
                const nascita = new Date(a, m - 1, g);
                const oggi = new Date();
                let eta = oggi.getFullYear() - nascita.getFullYear();
                if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) eta--;
                
                display.className = 'age-display';
                display.textContent = `üéÇ ${eta} anni`;
                document.getElementById('dataNascita').value = `${a}-${String(m).padStart(2, '0')}-${String(g).padStart(2, '0')}`;
            } else {
                display.className = 'age-display empty';
                display.textContent = 'üéÇ - anni';
            }
        }
        
        function calcolaEtaDaForm() {
            console.log('üîç [ETA] Inizio calcolo et√†');
            
            const gInput = document.getElementById('giorno');
            const mInput = document.getElementById('mese');
            const aInput = document.getElementById('anno');
            
            if (!gInput || !mInput || !aInput) {
                console.warn('‚ö†Ô∏è [ETA] Campi data non trovati');
                return '';
            }
            
            const g = parseInt(gInput.value);
            const m = parseInt(mInput.value);
            const a = parseInt(aInput.value);
            
            console.log('üîç [ETA] Valori letti:', { g, m, a });
            
            if (g && m && a && g <= 31 && m <= 12 && a >= 1900 && a <= 2025) {
                const nascita = new Date(a, m - 1, g);
                const oggi = new Date();
                let eta = oggi.getFullYear() - nascita.getFullYear();
                if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) eta--;
                console.log('‚úÖ [ETA] Et√† calcolata:', eta);
                return eta;
            }
            
            console.warn('‚ö†Ô∏è [ETA] Dati non validi, ritorno stringa vuota');
            return '';
        }
        
        function impostaDataOggi() {
            document.getElementById('dataCompilazione').value = new Date().toISOString().split('T')[0];
        }
        
        function nuovaScheda() {
            // ‚úÖ FIX v3.6.13: Rimosso confirm inutile
                try {
                    console.log('üßπ [NUOVA SCHEDA] Inizio pulizia form...');
                    
                    // 1. Reset flag modifica
                    SCHEDA_IN_MODIFICA = false;
                    console.log('‚úÖ [NUOVA SCHEDA] Flag modifica = false');
                    
                    // 2. Ottieni riferimento al form
                    const form = document.getElementById('assistitoForm');
                    if (!form) {
                        throw new Error('Form assistitoForm non trovato!');
                    }
                    
                    // 3. Reset form HTML
                    form.reset();
                    console.log('‚úÖ [NUOVA SCHEDA] Form reset() eseguito');
                    
                    // 4. Pulizia MANUALE di tutti i campi
                    const allInputs = form.querySelectorAll('input, select, textarea');
                    console.log(`üìù [NUOVA SCHEDA] Trovati ${allInputs.length} campi da pulire`);
                    
                    let puliti = 0;
                    allInputs.forEach(input => {
                        try {
                            if (input.type === 'checkbox' || input.type === 'radio') {
                                input.checked = false;
                            } else if (input.id !== 'dataCompilazione') {
                                input.value = '';
                            }
                            puliti++;
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Errore pulizia campo:', input.id, e);
                        }
                    });
                    console.log(`‚úÖ [NUOVA SCHEDA] ${puliti}/${allInputs.length} campi puliti`);
                    
                    // 5. Imposta data odierna
                    const oggi = new Date().toISOString().split('T')[0];
                    const dataComp = document.getElementById('dataCompilazione');
                    if (dataComp) {
                        dataComp.value = oggi;
                        console.log(`‚úÖ [NUOVA SCHEDA] Data compilazione = ${oggi}`);
                    }
                    
                    // 6. Reset display et√†
                    const ageDisplay = document.getElementById('ageDisplay');
                    if (ageDisplay) {
                        ageDisplay.className = 'age-display empty';
                        ageDisplay.textContent = 'üéÇ - anni';
                    }
                    
                    // 7. Cambia tab per rendere visibile il form
                    console.log('üì° [NUOVA SCHEDA] Cambio tab a nuova...');
                    switchTab('nuova');
                    
                    // 8. Scroll al form dopo breve delay
                    setTimeout(() => {
                        const formElement = document.getElementById('assistitoForm');
                        if (formElement) {
                            formElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            console.log('üìç [NUOVA SCHEDA] Scroll al form completato');
                        }
                    }, 200);
                    
                    console.log('‚ú® [NUOVA SCHEDA] Form completamente pulito e pronto!');
                    
                } catch (error) {
                    console.error('‚ùå [NUOVA SCHEDA] ERRORE:', error);
                    alert('‚ùå Errore durante la creazione del form:\n' + error.message + '\n\nRicarica la pagina e riprova.');
                }
        }
        
        // ========================================
        // ‚úÖ FIX CORS: SALVATAGGIO SCHEDA
        // ========================================
        document.getElementById('assistitoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaScheda();
        });
        
        function salvaScheda() {
            console.log('üîç [DEBUG 1] Inizio salvaScheda()');
            
            try {
                const form = document.getElementById('assistitoForm');
                console.log('üîç [DEBUG 2] Form trovato:', form ? 'OK' : 'ERRORE');
                
                if (!form) {
                    alert('‚ùå ERRORE: Form assistitoForm non trovato!');
                    return;
                }
                
                console.log('üîç [DEBUG 3] Calcolo et√†...');
                let eta;
                try {
                    eta = calcolaEtaDaForm();
                    console.log('üîç [DEBUG 4] Et√† calcolata:', eta);
                } catch (etaError) {
                    console.error('‚ùå Errore calcolo et√†:', etaError);
                    eta = '';
                }
                
                console.log('üîç [DEBUG 5] Creazione schedaData...');
                const schedaData = {
                numeroScheda: form.numeroScheda.value,
                nome: form.nome.value,
                cognome: form.cognome.value,
                dataNascita: document.getElementById('dataNascita').value,
                eta: eta,
                indirizzoResidenza: form.indirizzoResidenza.value,
                comune: form.comune.value,
                telFisso: form.telFisso.value,
                cellulare: form.cellulare.value,
                
                caregiverB_nome: form.caregiverB_nome.value,
                caregiverB_cognome: form.caregiverB_cognome.value,
                caregiverB_parentela: form.caregiverB_parentela.value,
                caregiverB_email: form.caregiverB_email.value,
                caregiverB_cellulare: form.caregiverB_cellulare.value,
                caregiverB_chiavi: form.caregiverB_chiavi.value,
                
                caregiverC_nome: form.caregiverC_nome.value,
                caregiverC_cognome: form.caregiverC_cognome.value,
                caregiverC_parentela: form.caregiverC_parentela.value,
                caregiverC_email: form.caregiverC_email.value,
                caregiverC_cellulare: form.caregiverC_cellulare.value,
                caregiverC_chiavi: form.caregiverC_chiavi.value,
                
                caregiverD_nome: form.caregiverD_nome.value,
                caregiverD_cognome: form.caregiverD_cognome.value,
                caregiverD_parentela: form.caregiverD_parentela.value,
                caregiverD_email: form.caregiverD_email.value,
                caregiverD_cellulare: form.caregiverD_cellulare.value,
                caregiverD_chiavi: form.caregiverD_chiavi.value,
                
                scalettaContatti: form.scalettaContatti.value,
                
                assSocialeNome: form.assSocialeNome.value,
                assSocialeCellulare: form.assSocialeCellulare.value,
                ossNome: form.ossNome.value,
                ossCellulare: form.ossCellulare.value,
                infermiereNome: form.infermiereNome.value,
                infermiereCellulare: form.infermiereCellulare.value,
                mmgNome: form.mmgNome.value,
                mmgCellulare: form.mmgCellulare.value,
                
                natoA: form.natoA.value,
                provinciaNascita: form.provinciaNascita.value,
                codiceFiscale: form.codiceFiscale.value,
                tipoAbitazione: form.tipoAbitazione.value,
                piano: form.piano.value,
                ascensore: form.ascensore.value,
                sesso: form.sesso.value,
                peso: form.peso.value,
                altezza: form.altezza.value,
                
                patologie: form.patologie.value,
                farmaci: form.farmaci.value,
                freqCardiacaMin: form.freqCardiacaMin.value,
                freqCardiacaMax: form.freqCardiacaMax.value,
                saturazioneMin: form.saturazioneMin.value,
                
                IMEI: form.serialeDispositivo.value,
                serialeDispositivo: form.serialeDispositivo.value,
                dataCompilazione: form.dataCompilazione.value,
                
                poltrone: form.poltrone.value,
                sensoreLuce: form.sensoreLuce.value,
                sensoreEcg: form.sensoreEcg.value,
                note: form.note.value,
                
                installazionePoltrona: form.installazionePoltrona.value,
                installazioneSensoreLuce: form.installazioneSensoreLuce.value,
                installazioneSensoreEcg: form.installazioneSensoreEcg.value,
                
                meseInstallazionePrevisto: form.meseInstallazionePrevisto.value,
                notePianificazione: form.notePianificazione.value,
                meseInstallazionePoltrona: form.meseInstallazionePoltrona.value,
                meseInstallazioneSensoreLuce: form.meseInstallazioneSensoreLuce.value,
                meseInstallazioneSensoreEcg: form.meseInstallazioneSensoreEcg.value
            };
            
            console.log('üîç [DEBUG 6] schedaData creato OK');
            console.log('üì§ Invio scheda:', schedaData);
            
            // ‚úÖ FIX v3.5.2: Determina se INSERT o UPDATE
            const isNuovaScheda = !SCHEDA_IN_MODIFICA;
            console.log(`üì§ Invio scheda - Modalit√†: ${isNuovaScheda ? 'INSERT (Nuova)' : 'UPDATE (Modifica)'}`);
            
            console.log('üîç [DEBUG 7] Inizio fetch...');
            mostraLoading('Salvataggio...');
            
            fetch(DEPLOY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ 
                    action: 'save', 
                    scheda: schedaData 
                })
            })
            .then(() => {
                console.log('üîç [DEBUG 8] Fetch completato, verifica risposta...');
                nascondiLoading();
                mostraMessaggio('success', `‚úÖ Scheda ${schedaData.numeroScheda} ${isNuovaScheda ? 'creata con successo' : 'aggiornata con successo'}!`);
                setTimeout(() => {
                    console.log('üîç [DEBUG 9] Ricaricamento schede...');
                    caricaSchede();
                    // ‚úÖ FIX v3.5.3: Reset form silenzioso dopo INSERT, nessun dialog
                    if (isNuovaScheda) {
                        // Reset form silenzioso (no dialog)
                        SCHEDA_IN_MODIFICA = false;
                        document.getElementById('assistitoForm').reset();
                        impostaDataOggi();
                        document.getElementById('ageDisplay').className = 'age-display empty';
                        document.getElementById('ageDisplay').textContent = 'üéÇ - anni';
                        console.log('‚úÖ Nuovo assistito creato, form resettato per prossimo inserimento');
                    } else {
                        // Dopo UPDATE: reset flag e torna alla dashboard
                        SCHEDA_IN_MODIFICA = false;
                        console.log('‚úÖ Scheda modificata con successo, flag reset');
                    }
                    console.log('üîç [DEBUG 10] Switch a dashboard...');
                    switchTab('dashboard');
                    console.log('‚úÖ [DEBUG 11] Procedura completata con successo');
                }, 1500);
            })
            .catch(error => {
                console.error('‚ùå [DEBUG 8] Errore fetch:', error);
                console.error('‚ùå Stack:', error.stack);
                nascondiLoading();
                mostraMessaggio('info', 'üì§ Scheda inviata (verifica manualmente su Google Sheet)');
                setTimeout(() => { 
                    caricaSchede();
                    SCHEDA_IN_MODIFICA = false; // Reset anche in caso di errore
                }, 2000);
            });
            
            } catch (error) {
                console.error('‚ùå [DEBUG FATALE] Errore in salvaScheda():', error);
                console.error('‚ùå Stack trace:', error.stack);
                nascondiLoading();
                alert('‚ùå ERRORE CRITICO: ' + error.message + '\nControlla console (F12) per dettagli');
            }
        }
        
        // ========================================
        // CONFIGURAZIONE OBIETTIVI
        // ========================================
        function toggleConfigPanel() {
            const panel = document.getElementById('config-obiettivi-panel');
            const icon = document.getElementById('config-toggle-icon');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                icon.textContent = '‚ñ≤';
                renderConfigObiettivi();
            } else {
                panel.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }
        
        function renderConfigObiettivi() {
            const comuni = Object.keys(OBIETTIVI_COMUNI);
            let htmlContent = '';
            
            comuni.forEach(comune => {
                const safeId = comune.replace(/\s+/g, '-').replace(/'/g, '');
                htmlContent += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">
                            ${comune}
                        </label>
                        <input 
                            type="number" 
                            id="obiettivo-${safeId}" 
                            value="${OBIETTIVI_COMUNI[comune]}" 
                            min="0" 
                            max="200"
                            style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center;"
                        />
                    </div>
                `;
            });
            
            document.getElementById('config-obiettivi-grid').innerHTML = htmlContent;
        }
        
        function salvaObiettivi() {
            const obiettivi = {};
            
            Object.keys(OBIETTIVI_COMUNI).forEach(comune => {
                const safeId = comune.replace(/\s+/g, '-').replace(/'/g, '');
                const element = document.getElementById('obiettivo-' + safeId);
                if (element) {
                    obiettivi[comune] = parseInt(element.value) || OBIETTIVI_COMUNI[comune];
                }
            });
            
            console.log('üíæ [1/5] Salvataggio obiettivi:', obiettivi);
            
            // ‚úÖ FIX v3.5.2: Aggiorna SUBITO la variabile globale PRIMA del fetch
            // Cos√¨ la dashboard si aggiorna immediatamente anche se il fetch fallisce
            OBIETTIVI_COMUNI = obiettivi;
            console.log('üíæ [2/5] Variabile globale OBIETTIVI_COMUNI aggiornata');
            
            aggiornaTabellaComuni(); // Aggiorna la UI subito
            console.log('üíæ [3/5] Dashboard aggiornata localmente');
            
            mostraLoading('Salvataggio obiettivi su Google Sheet...');
            console.log('üíæ [4/5] Invio richiesta POST a Google Apps Script...');
            
            fetch(DEPLOY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'setObiettivi',
                    obiettivi: obiettivi
                })
            })
            .then(() => {
                console.log('üíæ [5/5] ‚úÖ Richiesta POST inviata al backend');
                nascondiLoading();
                alert('‚úÖ Obiettivi salvati localmente!\n\nüìã Per verificare la sincronizzazione:\n1. Apri Google Sheet\n2. Vai al foglio "Obiettivi"\n3. Verifica che i valori siano aggiornati');
                toggleConfigPanel();
            })
            .catch(e => {
                console.error('üíæ [5/5] ‚ö†Ô∏è Errore richiesta POST:', e);
                nascondiLoading();
                alert('‚ö†Ô∏è Errore salvataggio:\n' + e.message + '\n\nObiettivi salvati solo localmente.\nVerifica connessione internet e Google Apps Script.');
            });
        }
        
        function resetObiettivi() {
            if (confirm('‚ö†Ô∏è Ripristinare gli obiettivi predefiniti?')) {
                OBIETTIVI_COMUNI = {
                    '': 46,
                    '': 19,
                    'Vald': 8,
                    '': 8,
                    '': 7,
                    '': 4,
                    '': 3,
                    '': 3,
                    '': 2
                };
                renderConfigObiettivi();
                alert('üîÑ Obiettivi ripristinati! Clicca "Salva" per confermare.');
            }
        }
        
        function setupPianificazioneListeners() {
            // Placeholder
        }
        
        // ========================================
        // UTILITY
        // ========================================
        function mostraLoading(testo) {
            document.getElementById('loadingText').textContent = testo;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function nascondiLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function mostraMessaggio(tipo, testo) {
            const box = document.getElementById('messageBox');
            box.className = 'message ' + tipo;
            box.textContent = testo;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 8000);  // 8 secondi
        }

        // ========================================
        // ‚úÖ FIX v3.6.13: PROTEZIONE DATI NON SALVATI
        // ========================================
        
        let FORM_MODIFICATO = false;  // Flag globale per tracciare modifiche
        
        // Inizializza listener per tracciare modifiche al form
        function initFormChangeTracking() {
            const form = document.getElementById('assistitoForm');
            if (!form) return;
            
            // Ascolta tutti gli input, textarea e select nel form
            form.querySelectorAll('input, textarea, select').forEach(campo => {
                campo.addEventListener('change', () => {
                    FORM_MODIFICATO = true;
                    console.log('‚ö†Ô∏è Form modificato - protezione attiva');
                });
                
                // Anche per i campi di testo (input/change non bastano)
                if (campo.type === 'text' || campo.tagName === 'TEXTAREA') {
                    campo.addEventListener('input', () => {
                        FORM_MODIFICATO = true;
                    });
                }
            });
            
            console.log('üõ°Ô∏è Protezione modifiche form inizializzata');
        }
        
        // Reset flag dopo salvataggio
        document.getElementById('assistitoForm')?.addEventListener('submit', (e) => {
            FORM_MODIFICATO = false;
            console.log('üíæ Form salvato - protezione disattivata');
        });
        
        // Funzione per pulsante in fondo al form (con conferma)
        function nuovaSchedaConConferma() {
            console.log('üîµ Pulsante NUOVA SCHEDA (fondo form) premuto');
            
            // Se il form √® stato modificato, chiedi conferma
            if (FORM_MODIFICATO) {
                const conferma = confirm(
                    '‚ö†Ô∏è ATTENZIONE\n\n' +
                    'Hai modificato il form senza salvare.\n\n' +
                    'Vuoi davvero creare una nuova scheda?\n' +
                    'Le modifiche NON salvate andranno perse.'
                );
                
                if (!conferma) {
                    console.log('‚ùå Utente ha annullato - dati preservati');
                    return;  // Annulla operazione
                }
                
                console.log('‚ö†Ô∏è Utente ha confermato - dati persi');
            }
            
            // Pulisci il form (usa la funzione esistente)
            nuovaScheda();
        }
        
        // Inizializza tracciamento al caricamento della pagina
        window.addEventListener('DOMContentLoaded', () => {
            initFormChangeTracking();
            console.log('‚úÖ Sistema protezione dati caricato');
        });
    </script>
</body>
</html>
