<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeleCare H24 - CSP Novi Ligure</title>
    
    <!-- Icona Torre del Castello di Novi Ligure -->
    <link rel="apple-touch-icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6c/Castello_di_Novi_Ligure_-_torre.png/300px-Castello_di_Novi_Ligure_-_torre.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TeleCare H24">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        
        .nav-tabs {
            background: #f8f9fa;
            display: flex;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            min-width: 140px;
            padding: 18px 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .nav-tab:hover { background: #e9ecef; }
        
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stat-number {
            font-size: 48px;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
        }
        
        /* Lista assistiti */
        .assistiti-container {
            margin-top: 20px;
        }
        
        .filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 15px;
            min-width: 200px;
            cursor: pointer;
        }
        
        .filter-bar label {
            font-weight: 600;
            color: #667eea;
        }
        
        .list-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .list-table thead {
            background: #667eea;
            color: white;
        }
        
        .list-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .list-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .list-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Ricerca */
        .search-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 18px;
            border: 2px solid #667eea;
            border-radius: 10px;
            outline: none;
        }
        
        .search-results {
            margin-top: 20px;
            display: grid;
            gap: 15px;
        }
        
        .assistito-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .assistito-card:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .assistito-info { flex: 1; }
        
        .assistito-nome {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        /* Tabella Comuni */
        .comuni-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .comuni-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .comuni-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .comuni-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .comuni-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .progress-mini {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-mini-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        .assistito-dettagli {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .assistito-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* Form styling */
        .form-section {
            margin-bottom: 35px;
        }
        
        .form-section-title {
            font-size: 20px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
            margin-bottom: 20px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea { min-height: 100px; resize: vertical; }
        
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-input-group input {
            text-align: center;
            font-weight: 600;
        }
        
        .age-display {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }
        
        .age-display.empty {
            background: #e9ecef;
            color: #999;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container { border-radius: 0; }
            .form-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .nav-tab { min-width: 110px; font-size: 13px; padding: 15px 8px; }
            .filter-bar { flex-direction: column; }
            .filter-bar select { width: 100%; }
        }
    
        /* Autocomplete Styling */
        input[list] {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23667eea" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
            padding-right: 40px;
        }
        
        input[list]:focus {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23667eea" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 14l5-5 5 5z"/></svg>');
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">v1.0.14</div>
            <h1>üè• TeleCare H24 - CSP Novi Ligure</h1>
            <p>Progetto FNNA | 50 Assistiti | Dic 2025 - Mar 2026</p>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="switchTab('installati')">‚úÖ Installati</button>
            <button class="nav-tab" onclick="switchTab('pianificati')">üìÖ Pianificati</button>
            <button class="nav-tab" onclick="switchTab('ricerca')">üîç Ricerca</button>
            <button class="nav-tab" onclick="switchTab('nuova')">‚ûï Nuova</button>
        </div>
        
        <!-- TAB DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="stat-totale">0</span>
                    <span class="stat-label">Totale Assistiti</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-installati">0</span>
                    <span class="stat-label">Dispositivi Installati</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-pianificati">0</span>
                    <span class="stat-label">Installazioni Pianificate</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-comuni">0</span>
                    <span class="stat-label">Comuni Coperti</span>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìà Riepilogo Progetto</h2>
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Obiettivo Totale</div>
                            <div style="font-size: 32px; font-weight: bold; color: #667eea;">50</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Scadenza PNRR</div>
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;">31 Marzo 2026</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Progresso</div>
                            <div style="font-size: 32px; font-weight: bold; color: #28a745;" id="dashboard-progress">0%</div>
                        </div>
                        <div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Da Completare</div>
                            <div style="font-size: 32px; font-weight: bold; color: #ffc107;" id="dashboard-remaining">50</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">Avanzamento Installazioni</div>
                        <div style="background: #e9ecef; height: 30px; border-radius: 15px; overflow: hidden;">
                            <div id="progress-bar" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    
                    <!-- PANNELLO CONFIGURAZIONE OBIETTIVI -->
                    <div style="margin-top: 30px; background: linear-gradient(135deg, #fff3cd 0%, #ffc107 100%); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: #856404;">‚öôÔ∏è Configurazione Obiettivi per Comune</h3>
                            <button onclick="toggleConfigPanel()" style="background: white; border: 2px solid #856404; color: #856404; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                <span id="config-toggle-icon">‚ñº</span> Mostra/Nascondi
                            </button>
                        </div>
                        <div id="config-obiettivi-panel" style="display: none; background: white; padding: 20px; border-radius: 8px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;" id="config-obiettivi-grid">
                                <!-- Popolato dinamicamente -->
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="salvaObiettivi()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.2); transition: all 0.3s;">
                                    üíæ Salva Obiettivi
                                </button>
                                <button onclick="resetObiettivi()" style="background: #dc3545; color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-left: 10px; transition: all 0.3s;">
                                    üîÑ Ripristina Default
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- STATISTICA PER COMUNE -->
            <div style="margin-top: 40px;">
                <h2 style="color: #667eea; margin-bottom: 20px;">üèòÔ∏è Distribuzione per Comune</h2>
                <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                    <table class="comuni-table">
                        <thead>
                            <tr>
                                <th>Comune</th>
                                <th style="text-align: center;">Assistiti Attuali</th>
                                <th style="text-align: center;">Installati</th>
                                <th style="text-align: center;">Obiettivo</th>
                                <th style="text-align: center;">% Completamento</th>
                                <th>Avanzamento</th>
                                <th style="text-align: center;">Mancanti</th>
                            </tr>
                        </thead>
                        <tbody id="comuni-table-body">
                            <!-- Popolato dinamicamente da JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="mostraTutteLeSchede()" class="btn btn-primary" style="font-size: 18px;">
                    üìã Visualizza Tutte le Schede
                </button>
            </div>
        </div>
        
        <!-- TAB INSTALLATI -->
        <div id="tab-installati" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">‚úÖ Dispositivi Installati (<span id="count-installati">0</span>)</h2>
            
            <div class="filter-bar">
                <label>Filtra per Comune:</label>
                <select id="filter-comune-installati" onchange="filtraInstallati()">
                    <option value="">üåç Tutti i Comuni</option>
                                        <option value="Albera Ligure">Albera Ligure</option>
                    <option value="Arquata Scrivia">Arquata Scrivia</option>
                    <option value="Basaluzzo">Basaluzzo</option>
                    <option value="Borghetto Di Borbera">Borghetto Di Borbera</option>
                    <option value="Bosio">Bosio</option>
                    <option value="Cabella Ligure">Cabella Ligure</option>
                    <option value="Cantalupo Ligure">Cantalupo Ligure</option>
                    <option value="Capriata D&#39;Orba">Capriata D'Orba</option>
                    <option value="Carrega Ligure">Carrega Ligure</option>
                    <option value="Carrosio">Carrosio</option>
                    <option value="Cassano Spinola">Cassano Spinola</option>
                    <option value="Fraconalto">Fraconalto</option>
                    <option value="Francavilla Bisio">Francavilla Bisio</option>
                    <option value="Fresonara">Fresonara</option>
                    <option value="Gavi">Gavi</option>
                    <option value="Grondona">Grondona</option>
                    <option value="Mongiardino Ligure">Mongiardino Ligure</option>
                    <option value="Novi Ligure">Novi Ligure</option>
                    <option value="Parodi Ligure">Parodi Ligure</option>
                    <option value="Pasturana">Pasturana</option>
                    <option value="Pozzolo Formigaro">Pozzolo Formigaro</option>
                    <option value="Roccaforte Ligure">Roccaforte Ligure</option>
                    <option value="Rocchetta Ligure">Rocchetta Ligure</option>
                    <option value="San Cristoforo">San Cristoforo</option>
                    <option value="Sardigliano">Sardigliano</option>
                    <option value="Serravalle Scrivia">Serravalle Scrivia</option>
                    <option value="Stazzano">Stazzano</option>
                    <option value="Tassarolo">Tassarolo</option>
                    <option value="Vignole Borbera">Vignole Borbera</option>
                    <option value="Voltaggio">Voltaggio</option>
                </select>
            </div>
            
            <div id="lista-installati-full" class="assistiti-container"></div>
        </div>
        
        <!-- TAB PIANIFICATI -->
        <div id="tab-pianificati" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìÖ Installazioni Pianificate (<span id="count-pianificati">0</span>)</h2>
            
            <div class="filter-bar">
                <label>Filtra per Mese:</label>
                <select id="filter-mese-pianificati" onchange="filtraPianificati()">
                    <option value="">üìÖ Tutti i Mesi</option>
                    <option value="Dicembre 2025">Dicembre 2025</option>
                    <option value="Gennaio 2026">Gennaio 2026</option>
                    <option value="Febbraio 2026">Febbraio 2026</option>
                    <option value="Marzo 2026">Marzo 2026</option>
                </select>
                
                <label>Filtra per Comune:</label>
                <select id="filter-comune-pianificati" onchange="filtraPianificati()">
                    <option value="">üåç Tutti i Comuni</option>
                                        <option value="Albera Ligure">Albera Ligure</option>
                    <option value="Arquata Scrivia">Arquata Scrivia</option>
                    <option value="Basaluzzo">Basaluzzo</option>
                    <option value="Borghetto Di Borbera">Borghetto Di Borbera</option>
                    <option value="Bosio">Bosio</option>
                    <option value="Cabella Ligure">Cabella Ligure</option>
                    <option value="Cantalupo Ligure">Cantalupo Ligure</option>
                    <option value="Capriata D&#39;Orba">Capriata D'Orba</option>
                    <option value="Carrega Ligure">Carrega Ligure</option>
                    <option value="Carrosio">Carrosio</option>
                    <option value="Cassano Spinola">Cassano Spinola</option>
                    <option value="Fraconalto">Fraconalto</option>
                    <option value="Francavilla Bisio">Francavilla Bisio</option>
                    <option value="Fresonara">Fresonara</option>
                    <option value="Gavi">Gavi</option>
                    <option value="Grondona">Grondona</option>
                    <option value="Mongiardino Ligure">Mongiardino Ligure</option>
                    <option value="Novi Ligure">Novi Ligure</option>
                    <option value="Parodi Ligure">Parodi Ligure</option>
                    <option value="Pasturana">Pasturana</option>
                    <option value="Pozzolo Formigaro">Pozzolo Formigaro</option>
                    <option value="Roccaforte Ligure">Roccaforte Ligure</option>
                    <option value="Rocchetta Ligure">Rocchetta Ligure</option>
                    <option value="San Cristoforo">San Cristoforo</option>
                    <option value="Sardigliano">Sardigliano</option>
                    <option value="Serravalle Scrivia">Serravalle Scrivia</option>
                    <option value="Stazzano">Stazzano</option>
                    <option value="Tassarolo">Tassarolo</option>
                    <option value="Vignole Borbera">Vignole Borbera</option>
                    <option value="Voltaggio">Voltaggio</option>
                </select>
            </div>
            
            <div id="lista-pianificati-full" class="assistiti-container"></div>
        </div>
        
        <!-- TAB RICERCA -->
        <div id="tab-ricerca" class="tab-content">
            <div class="search-box">
                <h2 style="margin-bottom: 15px; color: #667eea;">üîç Cerca Assistito</h2>
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       list="assistiti-suggestions"
                       placeholder="Digita nome, cognome, numero scheda o comune... (autocomplete attivo)"
                       autocomplete="off">
            <datalist id="assistiti-suggestions">
                <!-- Popolato dinamicamente via JavaScript -->
            </datalist>
            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                üí° <strong>Tip:</strong> L'autocomplete mostra suggerimenti mentre digiti. Premi freccia ‚Üì per vedere tutti i risultati.
            </div>
                       onkeyup="cercaAssistito()">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        
        <!-- TAB NUOVA SCHEDA -->
        <div id="tab-nuova" class="tab-content">
            <div class="message" id="messageBox"></div>
            
            <form id="assistitoForm">
                <!-- DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üë§ Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="numeroScheda">N¬∞ Scheda<span class="required">*</span></label>
                            <input type="text" id="numeroScheda" name="numeroScheda" required>
                        </div>

                        <div class="form-group">
                            <label for="dataCompilazione">Data Compilazione</label>
                            <input type="date" id="dataCompilazione" name="dataCompilazione">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome<span class="required">*</span></label>
                            <input type="text" id="nome" name="nome" required>
                        </div>

                        <div class="form-group">
                            <label for="cognome">Cognome<span class="required">*</span></label>
                            <input type="text" id="cognome" name="cognome" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data di Nascita<span class="required">*</span></label>
                            <div class="date-input-group">
                                <input type="number" id="giorno" name="giorno" placeholder="GG" min="1" max="31" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="mese" name="mese" placeholder="MM" min="1" max="12" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="anno" name="anno" placeholder="AAAA" min="1900" max="2025" maxlength="4" required>
                            </div>
                            <input type="hidden" id="dataNascita" name="dataNascita">
                        </div>

                        <div class="form-group">
                            <label>Et√†</label>
                            <div class="age-display empty" id="ageDisplay">
                                üéÇ - anni
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="indirizzoResidenza">Indirizzo Residenza</label>
                            <input type="text" id="indirizzoResidenza" name="indirizzoResidenza">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="comune">Comune di Residenza<span class="required">*</span></label>
                            <input type="text" 
                                   id="comune" 
                                   name="comune" 
                                   list="comuni-list" 
                                   required
                                   placeholder="Digita per cercare... (es: Nov, Arq, Ser)"
                                   autocomplete="off">
                            <datalist id="comuni-list">
                                    <option value="Albera Ligure">
                                    <option value="Arquata Scrivia">
                                    <option value="Basaluzzo">
                                    <option value="Borghetto Di Borbera">
                                    <option value="Bosio">
                                    <option value="Cabella Ligure">
                                    <option value="Cantalupo Ligure">
                                    <option value="Capriata D'Orba">
                                    <option value="Carrega Ligure">
                                    <option value="Carrosio">
                                    <option value="Cassano Spinola">
                                    <option value="Fraconalto">
                                    <option value="Francavilla Bisio">
                                    <option value="Fresonara">
                                    <option value="Gavi">
                                    <option value="Grondona">
                                    <option value="Mongiardino Ligure">
                                    <option value="Novi Ligure">
                                    <option value="Parodi Ligure">
                                    <option value="Pasturana">
                                    <option value="Pozzolo Formigaro">
                                    <option value="Roccaforte Ligure">
                                    <option value="Rocchetta Ligure">
                                    <option value="San Cristoforo">
                                    <option value="Sardigliano">
                                    <option value="Serravalle Scrivia">
                                    <option value="Stazzano">
                                    <option value="Tassarolo">
                                    <option value="Vignole Borbera">
                                    <option value="Voltaggio">
                            </datalist>
                            <!-- üí° TIP: Digita le prime lettere per filtrare i comuni -->
                        </div>

                        <div class="form-group">
                            <label for="telFisso">Telefono Fisso</label>
                            <input type="tel" id="telFisso" name="telFisso" placeholder="0143...">
                        </div>

                        <div class="form-group">
                            <label for="cellulare">Cellulare</label>
                            <input type="tel" id="cellulare" name="cellulare" placeholder="333...">
                        </div>
                    </div>
                </div>

                <!-- CAREGIVER -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üë• Caregiver</h2>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver B</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverB_nome">Nome</label>
                                <input type="text" id="caregiverB_nome" name="caregiverB_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cognome">Cognome</label>
                                <input type="text" id="caregiverB_cognome" name="caregiverB_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_parentela">Parentela</label>
                                <input type="text" id="caregiverB_parentela" name="caregiverB_parentela" placeholder="Es: Figlio/a">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_email">Email</label>
                                <input type="email" id="caregiverB_email" name="caregiverB_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverB_cellulare" name="caregiverB_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_chiavi">Chiavi</label>
                                <select id="caregiverB_chiavi" name="caregiverB_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver C</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverC_nome">Nome</label>
                                <input type="text" id="caregiverC_nome" name="caregiverC_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cognome">Cognome</label>
                                <input type="text" id="caregiverC_cognome" name="caregiverC_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_parentela">Parentela</label>
                                <input type="text" id="caregiverC_parentela" name="caregiverC_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_email">Email</label>
                                <input type="email" id="caregiverC_email" name="caregiverC_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverC_cellulare" name="caregiverC_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_chiavi">Chiavi</label>
                                <select id="caregiverC_chiavi" name="caregiverC_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver D</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverD_nome">Nome</label>
                                <input type="text" id="caregiverD_nome" name="caregiverD_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cognome">Cognome</label>
                                <input type="text" id="caregiverD_cognome" name="caregiverD_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_parentela">Parentela</label>
                                <input type="text" id="caregiverD_parentela" name="caregiverD_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_email">Email</label>
                                <input type="email" id="caregiverD_email" name="caregiverD_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverD_cellulare" name="caregiverD_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_chiavi">Chiavi</label>
                                <select id="caregiverD_chiavi" name="caregiverD_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="scalettaContatti">Scaletta Contatti C.O.</label>
                        <textarea id="scalettaContatti" name="scalettaContatti" placeholder="Ordine di priorit√† per contattare i caregiver..."></textarea>
                    </div>
                </div>

                <!-- ALTRI DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üìù Altri Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="natoA">Nato a</label>
                            <input type="text" id="natoA" name="natoA">
                        </div>
                        <div class="form-group">
                            <label for="provincia">Provincia</label>
                            <input type="text" id="provincia" name="provincia" maxlength="2" placeholder="AL">
                        </div>
                        <div class="form-group">
                            <label for="codiceFiscale">Codice Fiscale</label>
                            <input type="text" id="codiceFiscale" name="codiceFiscale" maxlength="16" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoAbitazione">Tipo Abitazione</label>
                            <select id="tipoAbitazione" name="tipoAbitazione">
                                <option value="">Seleziona...</option>
                                <option value="Appartamento">üè¢ Appartamento</option>
                                <option value="Casa">üè† Casa Indipendente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="piano">Piano</label>
                            <input type="number" id="piano" name="piano" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="ascensore">Ascensore</label>
                            <select id="ascensore" name="ascensore">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sesso">Sesso</label>
                            <select id="sesso" name="sesso">
                                <option value="">-</option>
                                <option value="M">üë® M</option>
                                <option value="F">üë© F</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="peso">Peso (kg)</label>
                            <input type="number" id="peso" name="peso" min="0" placeholder="70">
                        </div>
                        <div class="form-group">
                            <label for="altezza">Altezza (cm)</label>
                            <input type="number" id="altezza" name="altezza" min="0" placeholder="170">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="patologie">Patologie e Fragilit√†</label>
                            <textarea id="patologie" name="patologie" placeholder="Elencare patologie croniche e condizioni di fragilit√†..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="farmaci">Farmaci e Orari</label>
                            <textarea id="farmaci" name="farmaci" placeholder="Es: ore 08:00 Cardioaspirin 100mg, ore 20:00 Eutirox 50mcg..."></textarea>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="freqCardiacaMin">Freq. Cardiaca Min (bpm)</label>
                            <input type="number" id="freqCardiacaMin" name="freqCardiacaMin" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label for="freqCardiacaMax">Freq. Cardiaca Max (bpm)</label>
                            <input type="number" id="freqCardiacaMax" name="freqCardiacaMax" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="saturazioneMin">Saturazione Min (%)</label>
                            <input type="number" id="saturazioneMin" name="saturazioneMin" min="70" max="100" placeholder="95">
                        </div>
                    </div>
                </div>

                <!-- AUSILI ED ECG -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üîß Ausili ed ECG</h2>
                    
                    <div class="form-grid">
                        <div class="form-group" style="display:none;">
                            <label for="poltrone">Poltrone antidecubito</label>
                            <select id="poltrone" name="poltrone">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                        <div class="form-group" style="display:none;">
                            <label for="sensoreLuce">Sensore Luce</label>
                            <select id="sensoreLuce" name="sensoreLuce">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sensoreEcg">Sensore ECG</label>
                            <select id="sensoreEcg" name="sensoreEcg">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="note">Note Aggiuntive</label>
                            <textarea id="note" name="note" placeholder="Eventuali informazioni aggiuntive rilevanti..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ALTRI CONTATTI -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üìû ALTRI CONTATTI</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="assSocialeNome">Nominativo Ass. Sociale</label>
                            <input type="text" id="assSocialeNome" name="assSocialeNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="assSocialeCellulare">N¬∞ Cellulare Ass. Sociale</label>
                            <input type="tel" id="assSocialeCellulare" name="assSocialeCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ossNome">Nominativo OSS</label>
                            <input type="text" id="ossNome" name="ossNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="ossCellulare">N¬∞ Cellulare OSS</label>
                            <input type="tel" id="ossCellulare" name="ossCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="infermiereNome">Nominativo Infermiere</label>
                            <input type="text" id="infermiereNome" name="infermiereNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="infermiereCellulare">N¬∞ Cellulare Infermiere</label>
                            <input type="tel" id="infermiereCellulare" name="infermiereCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mmgNome">Nominativo MMG</label>
                            <input type="text" id="mmgNome" name="mmgNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="mmgCellulare">N¬∞ Cellulare MMG</label>
                            <input type="tel" id="mmgCellulare" name="mmgCellulare" placeholder="3331234567">
                        </div>
                    </div>
                </div>

                <!-- PIANIFICAZIONE INSTALLAZIONE -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">üìÖ Pianificazione Installazione</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="meseInstallazionePrevisto">Mese Install. Dispositivo</label>
                            <select id="meseInstallazionePrevisto" name="meseInstallazionePrevisto">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="meseInstallazionePoltrona">Mese Install. Poltrona</label>
                            <select id="meseInstallazionePoltrona" name="meseInstallazionePoltrona">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="meseInstallazioneSensoreLuce">Mese Install. Sensore Luce</label>
                            <select id="meseInstallazioneSensoreLuce" name="meseInstallazioneSensoreLuce">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="meseInstallazioneSensoreEcg">Mese Install. Sensore ECG</label>
                            <select id="meseInstallazioneSensoreEcg" name="meseInstallazioneSensoreEcg">
                                <option value="">-- Seleziona --</option>
                                <option value="Novembre 2025">Nov 2025</option>
                                <option value="Dicembre 2025">Dic 2025</option>
                                <option value="Gennaio 2026">Gen 2026</option>
                                <option value="Febbraio 2026">Feb 2026</option>
                                <option value="Marzo 2026">Mar 2026</option>
                                <option value="Non pianificato">Non pianificato</option>
                            </select>
                        </div>
                    </div>


                </div>

                
                <!-- INSTALLAZIONE -->
                <div class="section">
                    <h2 class="section-title" style="margin-top: 40px; padding-top: 25px; border-top: 2px solid #e0e0e0;">‚öôÔ∏è Installazione</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="serialeDispositivo">Seriale Dispositivo</label>
                            <input type="text" id="serialeDispositivo" name="serialeDispositivo" placeholder="SN...">
                        </div>
                        <div class="form-group">
                            <label for="installazionePoltrona">Poltrona Installata</label>
                            <select id="installazionePoltrona" name="installazionePoltrona">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installazioneSensoreLuce">Sensore Luce Installato</label>
                            <select id="installazioneSensoreLuce" name="installazioneSensoreLuce">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installazioneSensoreEcg">Sensore ECG Installato</label>
                            <select id="installazioneSensoreEcg" name="installazioneSensoreEcg">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- VISUALIZZAZIONE SCELTE EFFETTUATE -->
                    
                    <div class="form-group full-width" style="margin-top: 15px;">
                        <label for="notePianificazione">Note Pianificazione</label>
                        <textarea id="notePianificazione" name="notePianificazione" placeholder="Eventuali note sulla pianificazione installazione..."></textarea>
                    </div>
                </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">
                        üíæ SALVA
                    </button>
                    <button type="button" class="btn-secondary" onclick="nuovaScheda()">
                        ‚ú® Nuova Scheda
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Caricamento...</p>
        </div>
    </div>
    
    <script>
        // ========================================
        // CONFIGURAZIONE
        // ========================================
        const DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbyVV5ihW7LeOHII3IyuXpMzZ_y0886Hy4f9MOoV2W9M7DtmE_Sndtc8kNw7r1W3Mebn/exec';
        
        let schedeCache = [];
        let installatiCache = [];
        let pianificatiCache = [];
        
        // ========================================
        // INIZIALIZZAZIONE
        // ========================================
        window.addEventListener('DOMContentLoaded', function() {
            setupPianificazioneListeners();
            impostaDataOggi();
            caricaSchede();
            setupDateInputs();
        });
        
        // ========================================
        // GESTIONE TAB
        // ========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                aggiornaDashboard();
            } else if (tabName === 'installati') {
                mostraInstallati();
            } else if (tabName === 'pianificati') {
                mostraPianificati();
            }
        }
        
        // ========================================
        // CARICAMENTO DATI
        // ========================================
        function caricaSchede() {
            mostraLoading('Caricamento dati...');
            
            fetch(DEPLOY_URL)
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Dati ricevuti:', data);
                    console.log('üìä data.schede length:', data.schede ? data.schede.length : 0);
                    if (data.success) {
                        schedeCache = data.schede || [];
                        
                        // Pre-filtra le cache
                        console.log('üìä schedeCache length:', schedeCache.length);
                        installatiCache = schedeCache.filter(s => s.IMEI && s.IMEI.trim() !== '');
                        console.log('üìä installatiCache length:', installatiCache.length);
                        pianificatiCache = schedeCache.filter(s => 
                            s.meseInstallazionePrevisto && 
                            s.meseInstallazionePrevisto !== 'Non pianificato' &&
                            s.meseInstallazionePrevisto !== '' &&
                            (!s.IMEI || s.IMEI.trim() === '')
                        );
                        console.log('üìä pianificatiCache length:', pianificatiCache.length);
                        
                        aggiornaDashboard();
                        nascondiLoading();
                        mostraMessaggio('success', `‚úÖ ${schedeCache.length} schede caricate`);
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    nascondiLoading();
                    mostraMessaggio('error', '‚ùå Errore caricamento dati');
                });
        }
        
        // ========================================
        // DASHBOARD
        // ========================================
        function aggiornaDashboard() {
            if (schedeCache.length === 0) return;
            
            const installati = installatiCache.length;
            const pianificati = pianificatiCache.length;
            const comuni = new Set(schedeCache.map(s => s.comune).filter(c => c)).size;
            const totale = schedeCache.length;
            const progresso = Math.round((installati / 50) * 100);
            const rimanenti = 50 - installati;
            
            document.getElementById('stat-totale').textContent = totale;
            document.getElementById('stat-installati').textContent = installati;
            document.getElementById('stat-pianificati').textContent = pianificati;
            document.getElementById('stat-comuni').textContent = comuni;
            document.getElementById('dashboard-progress').textContent = progresso + '%';
            document.getElementById('dashboard-remaining').textContent = rimanenti;
            document.getElementById('progress-bar').style.width = progresso + '%';
            
            // Aggiorna tabella comuni
            aggiornaTabellaComuni();
        }
        
        // ========================================
        // TABELLA DISTRIBUZIONE PER COMUNE
        // ========================================
        function aggiornaTabellaComuni() {
            // Carica obiettivi da localStorage o usa default
            const defaultObiettivi = {
                'Novi Ligure': 19,
                'Serravalle Scrivia': 9,
                'Arquata Scrivia': 8,
                'Gavi': 5,
                'Basaluzzo': 1,
                'Bosio': 1,
                'Cassano Spinola': 1,
                'Fresonara': 1,
                'Pozzolo Formigaro': 1,
                'Stazzano': 1,
                'Tassarolo': 1,
                'Vignole Borbera': 1,
                'Voltaggio': 1,
                'Albera Ligure': 0,
                'Borghetto Di Borbera': 0,
                'Cabella Ligure': 0,
                'Cantalupo Ligure': 0,
                'Capriata D\'Orba': 0,
                'Carrega Ligure': 0,
                'Carrosio': 0,
                'Fraconalto': 0,
                'Francavilla Bisio': 0,
                'Grondona': 0,
                'Mongiardino Ligure': 0,
                'Parodi Ligure': 0,
                'Pasturana': 0,
                'Roccaforte Ligure': 0,
                'Rocchetta Ligure': 0,
                'San Cristoforo': 0,
                'Sardigliano': 0
            };
            
            let OBIETTIVI_COMUNI = defaultObiettivi;
            
            // Carica obiettivi dal Google Sheet invece di localStorage
            async function caricaObiettiviDalServer() {
                try {
                    console.log('üìä Caricamento obiettivi dal server...');
                    const response = await fetch(DEPLOY_URL + '?action=getObiettivi');
                    const data = await response.json();
                    
                    if (data.success && data.obiettivi) {
                        OBIETTIVI_COMUNI = data.obiettivi;
                        console.log('‚úÖ Obiettivi caricati dal server:', OBIETTIVI_COMUNI);
                        aggiornaDashboard();
                        renderConfigObiettivi();
                    } else {
                        console.log('‚ö†Ô∏è Usando obiettivi default');
                        OBIETTIVI_COMUNI = defaultObiettivi;
                    }
                } catch(e) {
                    console.log('‚ö†Ô∏è Errore caricamento obiettivi, uso default:', e);
                    OBIETTIVI_COMUNI = defaultObiettivi;
                }
            }
            
            const COMUNI_DISTRETTO = [

            ];
            
            // Conta assistiti e installati per comune
            const conteggioComuni = {};
            const installatiComuni = {};
            COMUNI_DISTRETTO.forEach(comune => {
                conteggioComuni[comune] = 0;
                installatiComuni[comune] = 0;
            });
            
            schedeCache.forEach(scheda => {
                if (scheda.comune && COMUNI_DISTRETTO.includes(scheda.comune)) {
                    conteggioComuni[scheda.comune]++;
                    // Conta installati: se ha IMEI o Seriale dispositivo, √® installato
                    const haImei = scheda.IMEI && scheda.IMEI.trim() !== '' && scheda.IMEI !== 'Non specificato';
                    const haSeriale = scheda.serialeDispositivo && scheda.serialeDispositivo.trim() !== '' && scheda.serialeDispositivo !== 'Non specificato';
                    if (haImei || haSeriale) {
                        installatiComuni[scheda.comune]++;
                    }
                }
            });
            
            // Ordina comuni per obiettivo (decrescente)
            const comuniOrdinati = COMUNI_DISTRETTO.sort((a, b) => OBIETTIVI_COMUNI[b] - OBIETTIVI_COMUNI[a]);
            
            // Genera HTML tabella
            let html = '';
            comuniOrdinati.forEach(comune => {
                const count = conteggioComuni[comune] || 0;
                const obiettivo = OBIETTIVI_COMUNI[comune];
                const percentuale = obiettivo > 0 ? Math.round((count / obiettivo) * 100) : 0;
                const mancanti = Math.max(0, obiettivo - count);
                
                let coloreBarra = '#667eea';
                let bgColor = '';
                if (percentuale >= 100) {
                    coloreBarra = '#28a745';
                    bgColor = 'background: #d4edda;';
                } else if (percentuale >= 75) {
                    coloreBarra = '#ffc107';
                    bgColor = 'background: #fff3cd;';
                } else if (percentuale >= 50) {
                    coloreBarra = '#fd7e14';
                } else if (percentuale > 0) {
                    coloreBarra = '#dc3545';
                }
                
                const installati = installatiComuni[comune] || 0;
                
                html += `
                    <tr style="${bgColor}">
                        <td><strong>${comune}</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 16px; color: #667eea;">${count}</strong></td>
                        <td style="text-align: center;"><strong style="font-size: 18px; color: #28a745;">${installati}</strong></td>
                        <td style="text-align: center;"><strong style="color: #764ba2;">${obiettivo}</strong></td>
                        <td style="text-align: center;"><strong style="color: ${coloreBarra};">${percentuale}%</strong></td>
                        <td>
                            <div class="progress-mini">
                                <div class="progress-mini-fill" style="width: ${Math.min(percentuale, 100)}%; background: ${coloreBarra};"></div>
                            </div>
                        </td>
                        <td style="text-align: center;"><span style="color: ${mancanti > 0 ? '#dc3545' : '#28a745'};">${mancanti}</span></td>
                    </tr>
                `;
            });
            
            // Calcola totali
            let totalAssistiti = 0;
            let totalInstallati = 0;
            let totalObiettivo = 0;
            let totalMancanti = 0;
            
            comuniOrdinati.forEach(comune => {
                totalAssistiti += conteggioComuni[comune] || 0;
                totalInstallati += installatiComuni[comune] || 0;
                totalObiettivo += OBIETTIVI_COMUNI[comune] || 0;
                totalMancanti += Math.max(0, OBIETTIVI_COMUNI[comune] - conteggioComuni[comune]);
            });
            
            const totalPercentuale = totalObiettivo > 0 ? Math.round((totalAssistiti / totalObiettivo) * 100) : 0;
            
            // Aggiungi riga totali
            html += `
                <tr style="background: #e9ecef; font-weight: bold; border-top: 3px solid #667eea;">
                    <td><strong>üìä TOTALE</strong></td>
                    <td style="text-align: center;"><strong style="font-size: 18px; color: #667eea;">${totalAssistiti}</strong></td>
                    <td style="text-align: center;"><strong style="font-size: 18px; color: #28a745;">${totalInstallati}</strong></td>
                    <td style="text-align: center;"><strong style="color: #764ba2;">${totalObiettivo}</strong></td>
                    <td style="text-align: center;"><strong style="color: ${totalPercentuale >= 100 ? '#28a745' : totalPercentuale >= 75 ? '#ffc107' : '#dc3545'};">${totalPercentuale}%</strong></td>
                    <td>
                        <div class="progress-mini">
                            <div class="progress-mini-fill" style="width: ${Math.min(totalPercentuale, 100)}%; background: ${totalPercentuale >= 100 ? '#28a745' : totalPercentuale >= 75 ? '#ffc107' : '#dc3545'};"></div>
                        </div>
                    </td>
                    <td style="text-align: center;"><strong style="color: ${totalMancanti > 0 ? '#dc3545' : '#28a745'};">${totalMancanti}</strong></td>
                </tr>
            `;
            
            document.getElementById('comuni-table-body').innerHTML = html;
        }
        
        // ========================================
        // TAB INSTALLATI
        // ========================================
        function mostraInstallati() {
            filtraInstallati();
        }
        
        // Formatta data mese in formato leggibile
        function formatMeseInstallazione(dataString) {
            if (!dataString || dataString === 'Non specificato' || dataString === 'Non pianificato') {
                return 'Non specificato';
            }
            
            // ‚úÖ Se √® gi√† nel formato "Mese Anno", restituiscilo direttamente
            if (typeof dataString === 'string' && /^[A-Za-z]+ \d{4}$/.test(dataString)) {
                return dataString;
            }
            
            try {
                const data = new Date(dataString);
                
                // Controlla se la data √® valida
                if (isNaN(data.getTime())) {
                    return 'Non specificato';
                }
                
                const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                
                return `${mesi[data.getMonth()]} ${data.getFullYear()}`;
            } catch(e) {
                return 'Non specificato';
            }
        }
        
        function filtraInstallati() {
            const filtroComune = document.getElementById('filter-comune-installati').value;
            
            let lista = installatiCache;
            if (filtroComune) {
                lista = installatiCache.filter(s => s.comune === filtroComune);
            }
            
            document.getElementById('count-installati').textContent = lista.length;
            
            if (lista.length === 0) {
                document.getElementById('lista-installati-full').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <p>Nessun dispositivo installato${filtroComune ? ' per ' + filtroComune : ''}</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Seriale (IMEI)</th><th>Mese Installazione</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            lista.forEach(s => {
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td><code>${s.IMEI || "-"}</code></td>
                    <td>${formatMeseInstallazione(s.meseInstallazionePrevisto)}</td>
                    <td><span class="badge badge-success">‚úÖ Installato</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('lista-installati-full').innerHTML = html;
        }
        
        // ========================================
        // TAB PIANIFICATI
        // ========================================
        function mostraPianificati() {
            filtraPianificati();
        }
        
        function filtraPianificati() {
            const filtroMese = document.getElementById('filter-mese-pianificati').value;
            const filtroComune = document.getElementById('filter-comune-pianificati').value;
            
            let lista = pianificatiCache;
            
            if (filtroMese) {
                lista = lista.filter(s => s.meseInstallazionePrevisto === filtroMese);
            }
            
            if (filtroComune) {
                lista = lista.filter(s => s.comune === filtroComune);
            }
            
            document.getElementById('count-pianificati').textContent = lista.length;
            
            if (lista.length === 0) {
                document.getElementById('lista-pianificati-full').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>Nessuna installazione pianificata${filtroMese ? ' per ' + filtroMese : ''}${filtroComune ? ' a ' + filtroComune : ''}</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Mese Previsto</th><th>Note</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            lista.forEach(s => {
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td>üìÖ ${formatMeseInstallazione(s.meseInstallazionePrevisto)}</td>
                    <td>${s.notePianificazione || '-'}</td>
                    <td><span class="badge badge-info">üìÖ Pianificato</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('lista-pianificati-full').innerHTML = html;
        }
        
        // ========================================
        // RICERCA ASSISTITO
        // ========================================
        function mostraTutteLeSchede() {
            // Switch al tab Ricerca e mostra tutte le schede
            switchTab('ricerca');
            
            // Svuota campo ricerca per mostrare tutte
            document.getElementById('searchInput').value = '';
            
            // Renderizza tutte le schede
            const resultsDiv = document.getElementById('search-results');
            
            if (schedeCache.length === 0) {
                resultsDiv.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Nessuna scheda disponibile</p>';
                return;
            }
            
            let html = '<table class="list-table"><thead><tr>';
            html += '<th>Scheda</th><th>Nome Completo</th><th>Comune</th><th>Data Nascita</th><th>Et√†</th><th>Cellulare</th><th>Stato</th>';
            html += '</tr></thead><tbody>';
            
            schedeCache.forEach(s => {
                const installato = s.IMEI && s.IMEI.trim() !== '';
                const pianificato = s.meseInstallazionePrevisto && s.meseInstallazionePrevisto !== 'Non pianificato' && s.meseInstallazionePrevisto !== '';
                
                let stato = '‚ö†Ô∏è Non pianificato';
                let badgeClass = 'badge-warning';
                if (installato) {
                    stato = '‚úÖ Installato';
                    badgeClass = 'badge-success';
                } else if (pianificato) {
                    stato = 'üìÖ Pianificato';
                    badgeClass = 'badge-info';
                }
                
                let eta = '-';
                if (s.dataNascita) {
                    const nascita = new Date(s.dataNascita);
                    const oggi = new Date();
                    let calcoloEta = oggi.getFullYear() - nascita.getFullYear();
                    if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) calcoloEta--;
                    eta = calcoloEta;
                }
                
                html += `<tr onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})' style="cursor: pointer;">
                    <td><strong>${s.numeroScheda || '-'}</strong></td>
                    <td>${s.nome || ''} ${s.cognome || ''}</td>
                    <td>üìç ${s.comune || ''}</td>
                    <td>${s.dataNascita ? new Date(s.dataNascita).toLocaleDateString('it-IT') : '-'}</td>
                    <td>${eta}</td>
                    <td>${s.cellulare || '-'}</td>
                    <td><span class="badge ${badgeClass}">${stato}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            resultsDiv.innerHTML = html;
        }
        
        function cercaAssistito() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            
            if (query === '') {
                resultsDiv.innerHTML = '<p style="color:#999;text-align:center;padding:20px">Digita per cercare un assistito</p>';
                return;
            }
            
            const risultati = schedeCache.filter(s => {
                const nome = (s.nome || '').toLowerCase();
                const cognome = (s.cognome || '').toLowerCase();
                const scheda = (s.numeroScheda || '').toLowerCase();
                const comune = (s.comune || '').toLowerCase();
                
                return nome.includes(query) || cognome.includes(query) || scheda.includes(query) || comune.includes(query);
            });
            
            if (risultati.length === 0) {
                resultsDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><p>Nessun assistito trovato</p></div>';
                return;
            }
            
            let html = '';
            risultati.forEach(s => {
                const installato = s.IMEI && s.IMEI.trim() !== '';
                const pianificato = s.meseInstallazionePrevisto && s.meseInstallazionePrevisto !== 'Non pianificato' && s.meseInstallazionePrevisto !== '';
                
                let badges = '';
                if (installato) {
                    badges += `<span class="badge badge-success">‚úÖ Installato</span>`;
                }
                if (pianificato) {
                    badges += `<span class="badge badge-info">üìÖ ${formatMeseInstallazione(s.meseInstallazionePrevisto)}</span>`;
                }
                if (!installato && !pianificato) {
                    badges += `<span class="badge badge-warning">‚ö†Ô∏è Non pianificato</span>`;
                }
                
                html += `
                    <div class="assistito-card" onclick='mostraDettaglioAssistito(${JSON.stringify(s).replace(/'/g, "&apos;")})'>
                        <div class="assistito-info">
                            <div class="assistito-nome">${s.nome || ''} ${s.cognome || ''}</div>
                            <div class="assistito-dettagli">
                                üìã Scheda: <strong>${s.numeroScheda || '-'}</strong> | 
                                üìç ${s.comune || '-'} | 
                                üéÇ ${s.dataNascita || '-'}
                            </div>
                            ${installato ? `<div class="assistito-dettagli" style="margin-top:5px">üì± IMEI: <code>${s.IMEI}</code></div>` : ''}
                        </div>
                        <div class="assistito-badges">
                            ${badges}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function mostraDettaglioAssistito(scheda) {
            // Carica la scheda completa nel form
            caricaSchedaCompleta(scheda);
            
            // Switch al tab "Nuova Scheda" 
            switchTab('nuova');
        }
        
function caricaSchedaCompleta(scheda) {
            // Popola TUTTI i 61 campi del form completo
            
            // DATI ASSISTITO (campi 1-9)
            document.getElementById('numeroScheda').value = scheda.numeroScheda || '';
            document.getElementById('nome').value = scheda.nome || '';
            document.getElementById('cognome').value = scheda.cognome || '';
            
            // Data nascita
            if (scheda.dataNascita) {
                const data = new Date(scheda.dataNascita);
                document.getElementById('giorno').value = data.getDate();
                document.getElementById('mese').value = data.getMonth() + 1;
                document.getElementById('anno').value = data.getFullYear();
                calcolaEta();
            }
            
            document.getElementById('indirizzoResidenza').value = scheda.indirizzoResidenza || '';
            document.getElementById('comune').value = scheda.comune || '';
            document.getElementById('telFisso').value = scheda.telFisso || '';
            document.getElementById('cellulare').value = scheda.cellulare || '';
            
            // CAREGIVER B (campi 10-14)
            if (document.getElementById('caregiverB_nome')) document.getElementById('caregiverB_nome').value = scheda.caregiverB_nome || '';
            if (document.getElementById('caregiverB_cognome')) document.getElementById('caregiverB_cognome').value = scheda.caregiverB_cognome || '';
            if (document.getElementById('caregiverB_parentela')) document.getElementById('caregiverB_parentela').value = scheda.caregiverB_parentela || '';
            if (document.getElementById('caregiverB_email')) document.getElementById('caregiverB_email').value = scheda.caregiverB_email || '';
            if (document.getElementById('caregiverB_cellulare')) document.getElementById('caregiverB_cellulare').value = scheda.caregiverB_cellulare || '';
            if (document.getElementById('caregiverB_chiavi')) document.getElementById('caregiverB_chiavi').value = scheda.caregiverB_chiavi || '';
            
            // CAREGIVER C (campi 15-20)
            if (document.getElementById('caregiverC_nome')) document.getElementById('caregiverC_nome').value = scheda.caregiverC_nome || '';
            if (document.getElementById('caregiverC_cognome')) document.getElementById('caregiverC_cognome').value = scheda.caregiverC_cognome || '';
            if (document.getElementById('caregiverC_parentela')) document.getElementById('caregiverC_parentela').value = scheda.caregiverC_parentela || '';
            if (document.getElementById('caregiverC_email')) document.getElementById('caregiverC_email').value = scheda.caregiverC_email || '';
            if (document.getElementById('caregiverC_cellulare')) document.getElementById('caregiverC_cellulare').value = scheda.caregiverC_cellulare || '';
            if (document.getElementById('caregiverC_chiavi')) document.getElementById('caregiverC_chiavi').value = scheda.caregiverC_chiavi || '';
            
            // CAREGIVER D (campi 21-26)
            if (document.getElementById('caregiverD_nome')) document.getElementById('caregiverD_nome').value = scheda.caregiverD_nome || '';
            if (document.getElementById('caregiverD_cognome')) document.getElementById('caregiverD_cognome').value = scheda.caregiverD_cognome || '';
            if (document.getElementById('caregiverD_parentela')) document.getElementById('caregiverD_parentela').value = scheda.caregiverD_parentela || '';
            if (document.getElementById('caregiverD_email')) document.getElementById('caregiverD_email').value = scheda.caregiverD_email || '';
            if (document.getElementById('caregiverD_cellulare')) document.getElementById('caregiverD_cellulare').value = scheda.caregiverD_cellulare || '';
            if (document.getElementById('caregiverD_chiavi')) document.getElementById('caregiverD_chiavi').value = scheda.caregiverD_chiavi || '';
            
            // CONTATTI SANITARI (campi 27-36)
            if (document.getElementById('scalettaContatti')) document.getElementById('scalettaContatti').value = scheda.scalettaContatti || '';
            if (document.getElementById('assSocialeNome')) document.getElementById('assSocialeNome').value = scheda.assSocialeNome || '';
            if (document.getElementById('assSocialeCellulare')) document.getElementById('assSocialeCellulare').value = scheda.assSocialeCellulare || '';
            if (document.getElementById('ossNome')) document.getElementById('ossNome').value = scheda.ossNome || '';
            if (document.getElementById('ossCellulare')) document.getElementById('ossCellulare').value = scheda.ossCellulare || '';
            if (document.getElementById('infermiereNome')) document.getElementById('infermiereNome').value = scheda.infermiereNome || '';
            if (document.getElementById('infermiereCellulare')) document.getElementById('infermiereCellulare').value = scheda.infermiereCellulare || '';
            if (document.getElementById('mmgNome')) document.getElementById('mmgNome').value = scheda.mmgNome || '';
            if (document.getElementById('mmgCellulare')) document.getElementById('mmgCellulare').value = scheda.mmgCellulare || '';
            
            // DATI ANAGRAFICI ESTESI (campi 37-39)
            if (document.getElementById('natoA')) document.getElementById('natoA').value = scheda.natoA || '';
            if (document.getElementById('provincia')) document.getElementById('provincia').value = scheda.provincia || '';
            if (document.getElementById('codiceFiscale')) document.getElementById('codiceFiscale').value = scheda.codiceFiscale || '';
            
            // ABITAZIONE (campi 40-42)
            if (document.getElementById('tipoAbitazione')) document.getElementById('tipoAbitazione').value = scheda.tipoAbitazione || '';
            if (document.getElementById('piano')) document.getElementById('piano').value = scheda.piano || '';
            if (document.getElementById('ascensore')) document.getElementById('ascensore').value = scheda.ascensore || '';
            
            // DATI SANITARI (campi 43-50)
            if (document.getElementById('sesso')) document.getElementById('sesso').value = scheda.sesso || '';
            if (document.getElementById('peso')) document.getElementById('peso').value = scheda.peso || '';
            if (document.getElementById('altezza')) document.getElementById('altezza').value = scheda.altezza || '';
            if (document.getElementById('patologie')) document.getElementById('patologie').value = scheda.patologie || '';
            if (document.getElementById('farmaci')) document.getElementById('farmaci').value = scheda.farmaci || '';
            if (document.getElementById('freqCardiacaMin')) document.getElementById('freqCardiacaMin').value = scheda.freqCardiacaMin || '';
            if (document.getElementById('freqCardiacaMax')) document.getElementById('freqCardiacaMax').value = scheda.freqCardiacaMax || '';
            if (document.getElementById('saturazioneMin')) document.getElementById('saturazioneMin').value = scheda.saturazioneMin || '';
            
            // DISPOSITIVO (campi 51-52)
            if (document.getElementById('serialeDispositivo')) document.getElementById('serialeDispositivo').value = scheda.IMEI || scheda.serialeDispositivo || '';
            if (document.getElementById('dataCompilazione')) document.getElementById('dataCompilazione').value = scheda.dataCompilazione || '';
            
            // DISPOSITIVI AGGIUNTIVI (campi 53-58)
            if (document.getElementById('poltrone')) document.getElementById('poltrone').value = scheda.poltrone || '';
            if (document.getElementById('sensoreLuce')) document.getElementById('sensoreLuce').value = scheda.sensoreLuce || '';
            if (document.getElementById('sensoreEcg')) document.getElementById('sensoreEcg').value = scheda.sensoreEcg || '';
            if (document.getElementById('installazionePoltrona')) document.getElementById('installazionePoltrona').value = scheda.installazionePoltrona || '';
            if (document.getElementById('installazioneSensoreLuce')) document.getElementById('installazioneSensoreLuce').value = scheda.installazioneSensoreLuce || '';
            if (document.getElementById('installazioneSensoreEcg')) document.getElementById('installazioneSensoreEcg').value = scheda.installazioneSensoreEcg || '';
            
            // PIANIFICAZIONE (campi 59-61)
            if (document.getElementById('meseInstallazionePrevisto')) document.getElementById('meseInstallazionePrevisto').value = scheda.meseInstallazionePrevisto || '';
            if (document.getElementById('meseInstallazionePoltrona')) document.getElementById('meseInstallazionePoltrona').value = '' /* scheda.meseInstallazionePoltrona - CSP Novi: nascosto */ || '';
            if (document.getElementById('meseInstallazioneSensoreLuce')) document.getElementById('meseInstallazioneSensoreLuce').value = '' /* scheda.meseInstallazioneSensoreLuce - CSP Novi: nascosto */ || '';
            if (document.getElementById('meseInstallazioneSensoreEcg')) document.getElementById('meseInstallazioneSensoreEcg').value = scheda.meseInstallazioneSensoreEcg || '';
            
            // Aggiorna display riepilogo
            setTimeout(aggiornaDisplayPianificazione, 100);
            if (document.getElementById('notePianificazione')) document.getElementById('notePianificazione').value = scheda.notePianificazione || '';
            if (document.getElementById('note')) document.getElementById('note').value = scheda.note || '';
        }
        
        // FUNZIONE SOSTITUITA CON VERSIONE COMPLETA (61 campi)
        // Vecchia funzione caricaSchedaCompleta rimossa
        /*
        function caricaSchedaCompleta_OLD(scheda) {
            // Popola tutti i campi del form
            document.getElementById('numeroScheda').value = scheda.numeroScheda || '';
            document.getElementById('nome').value = scheda.nome || '';
            document.getElementById('cognome').value = scheda.cognome || '';
            
            // Data nascita
            if (scheda.dataNascita) {
                const data = new Date(scheda.dataNascita);
                document.getElementById('giorno').value = data.getDate();
                document.getElementById('mese').value = data.getMonth() + 1;
                document.getElementById('anno').value = data.getFullYear();
                calcolaEta();
            }
            
            document.getElementById('indirizzoResidenza').value = scheda.indirizzoResidenza || '';
            document.getElementById('comune').value = scheda.comune || '';
            document.getElementById('telFisso').value = scheda.telFisso || '';
            document.getElementById('cellulare').value = scheda.cellulare || '';
            
            // Pianificazione
            document.getElementById('meseInstallazionePrevisto').value = scheda.meseInstallazionePrevisto || '';
            document.getElementById('notePianificazione').value = scheda.notePianificazione || '';
            document.getElementById('serialeDispositivo').value = scheda.IMEI || scheda.serialeDispositivo || '';
            
            // Data compilazione
            if (scheda.dataCompilazione) {
                document.getElementById('dataCompilazione').value = scheda.dataCompilazione;
            }
        */
        
        // ========================================
        // FORM GESTIONE
        // ========================================
        function setupDateInputs() {
            const giorno = document.getElementById('giorno');
            const mese = document.getElementById('mese');
            const anno = document.getElementById('anno');
            
            giorno.addEventListener('input', () => { if (giorno.value.length >= 2) mese.focus(); calcolaEta(); });
            mese.addEventListener('input', () => { if (mese.value.length >= 2) anno.focus(); calcolaEta(); });
            anno.addEventListener('input', calcolaEta);
        }
        
        function calcolaEta() {
            const g = parseInt(document.getElementById('giorno').value);
            const m = parseInt(document.getElementById('mese').value);
            const a = parseInt(document.getElementById('anno').value);
            const display = document.getElementById('ageDisplay');
            
            if (g && m && a && g <= 31 && m <= 12 && a >= 1900 && a <= 2025) {
                const nascita = new Date(a, m - 1, g);
                const oggi = new Date();
                let eta = oggi.getFullYear() - nascita.getFullYear();
                if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) eta--;
                
                display.className = 'age-display';
                display.textContent = `üéÇ ${eta} anni`;
                document.getElementById('dataNascita').value = `${a}-${String(m).padStart(2, '0')}-${String(g).padStart(2, '0')}`;
            } else {
                display.className = 'age-display empty';
                display.textContent = 'üéÇ - anni';
            }
        }
        
        function impostaDataOggi() {
            document.getElementById('dataCompilazione').value = new Date().toISOString().split('T')[0];
        }
        
        function resetForm() {
            if (confirm('Vuoi resettare il form?')) {
                document.getElementById('assistitoForm').reset();
                impostaDataOggi();
                document.getElementById('ageDisplay').className = 'age-display empty';
                document.getElementById('ageDisplay').textContent = 'üéÇ - anni';
            }
        }
        
        document.getElementById('assistitoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            salvaScheda();
        });
        
        function salvaScheda() {
            const formData = new FormData(document.getElementById('assistitoForm'));
            const schedaData = {};
            formData.forEach((value, key) => { schedaData[key] = value; });
            
            mostraLoading('Salvataggio...');
            
            fetch(DEPLOY_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'save', data: schedaData })
            })
            .then(() => {
                nascondiLoading();
                mostraMessaggio('success', `‚úÖ Scheda ${schedaData.numeroScheda} salvata!`);
                setTimeout(() => {
                    caricaSchede();
                    resetForm();
                    switchTab('dashboard');
                }, 1500);
            })
            .catch(error => {
                nascondiLoading();
                console.error(error);
                mostraMessaggio('info', 'üì§ Scheda inviata (modalit√† no-cors)');
                setTimeout(() => { caricaSchede(); }, 2000);
            });
        }
        
        // ========================================
        // UTILITY
        // ========================================
        function mostraLoading(testo) {
            document.getElementById('loadingText').textContent = testo;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function nascondiLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function mostraMessaggio(tipo, testo) {
            const box = document.getElementById('messageBox');
            box.className = 'message ' + tipo;
            box.textContent = testo;
            box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 5000);
        }
    
        // ========================================
        // CONFIGURAZIONE OBIETTIVI COMUNI
        // ========================================
        function toggleConfigPanel() {
            const panel = document.getElementById('config-obiettivi-panel');
            const icon = document.getElementById('config-toggle-icon');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                icon.textContent = '‚ñ≤';
                renderConfigObiettivi();
            } else {
                panel.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }
        
        function renderConfigObiettivi() {
            const defaultObiettivi = {
                'Novi Ligure': 19,
                'Serravalle Scrivia': 9,
                'Arquata Scrivia': 8,
                'Gavi': 5,
                'Basaluzzo': 1,
                'Bosio': 1,
                'Cassano Spinola': 1,
                'Fresonara': 1,
                'Pozzolo Formigaro': 1,
                'Stazzano': 1,
                'Tassarolo': 1,
                'Vignole Borbera': 1,
                'Voltaggio': 1,
                'Albera Ligure': 0,
                'Borghetto Di Borbera': 0,
                'Cabella Ligure': 0,
                'Cantalupo Ligure': 0,
                'Capriata D\'Orba': 0,
                'Carrega Ligure': 0,
                'Carrosio': 0,
                'Fraconalto': 0,
                'Francavilla Bisio': 0,
                'Grondona': 0,
                'Mongiardino Ligure': 0,
                'Parodi Ligure': 0,
                'Pasturana': 0,
                'Roccaforte Ligure': 0,
                'Rocchetta Ligure': 0,
                'San Cristoforo': 0,
                'Sardigliano': 0
            };
            
            let obiettivi = defaultObiettivi;
            try {
                const saved = localStorage.getItem('obiettivi_comuni');
                if (saved) {
                    obiettivi = JSON.parse(saved);
                }
            } catch(e) {
                console.log('Usando obiettivi default');
            }
            
            const comuni = Object.keys(obiettivi);
            let htmlContent = '';
            
            comuni.forEach(comune => {
                const safeId = comune.replace(/\s+/g, '-').replace(/'/g, '');
                htmlContent += `
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">
                            ${comune}
                        </label>
                        <input 
                            type="number" 
                            id="obiettivo-${safeId}" 
                            value="${obiettivi[comune]}" 
                            min="0" 
                            max="200"
                            style="width: 100%; padding: 10px; border: 2px solid #ced4da; border-radius: 6px; font-size: 16px; font-weight: 600; text-align: center;"
                        />
                    </div>
                `;
            });
            
            document.getElementById('config-obiettivi-grid').innerHTML = htmlContent;
        }
        
        function salvaObiettivi() {
            const obiettivi = {};
            
            // Leggi tutti i campi input in modo sicuro
            const defaultObiettivi = {
                'Novi Ligure': 19,
                'Serravalle Scrivia': 9,
                'Arquata Scrivia': 8,
                'Gavi': 5,
                'Basaluzzo': 1,
                'Bosio': 1,
                'Cassano Spinola': 1,
                'Fresonara': 1,
                'Pozzolo Formigaro': 1,
                'Stazzano': 1,
                'Tassarolo': 1,
                'Vignole Borbera': 1,
                'Voltaggio': 1,
                'Albera Ligure': 0,
                'Borghetto Di Borbera': 0,
                'Cabella Ligure': 0,
                'Cantalupo Ligure': 0,
                'Capriata D\'Orba': 0,
                'Carrega Ligure': 0,
                'Carrosio': 0,
                'Fraconalto': 0,
                'Francavilla Bisio': 0,
                'Grondona': 0,
                'Mongiardino Ligure': 0,
                'Parodi Ligure': 0,
                'Pasturana': 0,
                'Roccaforte Ligure': 0,
                'Rocchetta Ligure': 0,
                'San Cristoforo': 0,
                'Sardigliano': 0
            };
            
            Object.keys(defaultObiettivi).forEach(comune => {
                const safeId = comune.replace(/\s+/g, '-').replace(/'/g, '');
                const element = document.getElementById('obiettivo-' + safeId);
                if (element) {
                    obiettivi[comune] = parseInt(element.value) || defaultObiettivi[comune];
                } else {
                    console.warn('Elemento non trovato per: ' + comune);
                    obiettivi[comune] = defaultObiettivi[comune];
                }
            });
            
            // Salva obiettivi sul Google Sheet
            mostraLoading('Salvataggio obiettivi...');
            
            fetch(DEPLOY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'setObiettivi',
                    obiettivi: obiettivi
                })
            })
            .then(response => response.json())
            .then(data => {
                nascondiLoading();
                if (data.success) {
                    OBIETTIVI_COMUNI = obiettivi;
                    alert('‚úÖ Obiettivi salvati nel Google Sheet!\n\nOra tutti i browser vedranno gli stessi obiettivi.');
                    aggiornaTabellaComuni();
                    toggleConfigPanel();
                } else {
                    alert('‚ùå Errore: ' + (data.error || 'Errore sconosciuto'));
                }
            })
            .catch(e => {
                nascondiLoading();
                alert('‚ùå Errore di connessione: ' + e.message);
                console.error('Errore salvataggio obiettivi:', e);
            });
        }
        
        function resetObiettivi() {
            if (confirm('‚ö†Ô∏è Sei sicuro di voler ripristinare gli obiettivi predefiniti?\n\nQuesta azione canceller√† le tue modifiche.')) {
                try {
                    // Gli obiettivi saranno ripristinati al prossimo caricamento dal server
                    alert('üîÑ Obiettivi ripristinati ai valori predefiniti!');
                    aggiornaTabellaComuni();
                    toggleConfigPanel();
                } catch(e) {
                    alert('‚ùå Errore: ' + e.message);
                }
            }
        }

    
        // ========================================
        // AGGIORNAMENTO RIEPILOGO PIANIFICAZIONE
        // ========================================
        function aggiornaDisplayPianificazione() {
            const displays = {
                'display_meseDispositivo': 'meseInstallazionePrevisto',
                'display_mesePoltrona': 'meseInstallazionePoltrona',
                'display_meseSensoreLuce': 'meseInstallazioneSensoreLuce',
                'display_meseSensoreEcg': 'meseInstallazioneSensoreEcg'
            };
            
            Object.keys(displays).forEach(displayId => {
                const displayEl = document.getElementById(displayId);
                const selectEl = document.getElementById(displays[displayId]);
                if (displayEl && selectEl) {
                    displayEl.textContent = selectEl.value || '-';
                }
            });
        }
        
        // Listener per i select di pianificazione
        function setupPianificazioneListeners() {
            const selectIds = ['meseInstallazionePrevisto', 'meseInstallazionePoltrona', 
                             'meseInstallazioneSensoreLuce', 'meseInstallazioneSensoreEcg'];
            selectIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('change', aggiornaDisplayPianificazione);
                }
            });
        }

    
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUTOCOMPLETE INTELLIGENTE PER RICERCA ASSISTITI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        function updateAutocompleteAssistiti() {
            const datalist = document.getElementById('assistiti-suggestions');
            if (!datalist) return;
            
            // Pulisci datalist
            datalist.innerHTML = '';
            
            // Genera suggestions da schedeCache
            const suggestions = new Set();
            
            schedeCache.forEach(scheda => {
                // Aggiungi nome completo
                if (scheda.nome && scheda.cognome) {
                    suggestions.add(`${scheda.nome} ${scheda.cognome}`);
                }
                
                // Aggiungi numero scheda
                if (scheda.numeroScheda) {
                    suggestions.add(`Scheda ${scheda.numeroScheda}`);
                }
                
                // Aggiungi comune
                if (scheda.comune) {
                    suggestions.add(scheda.comune);
                }
            });
            
            // Ordina alfabeticamente e aggiungi a datalist
            Array.from(suggestions).sort().forEach(text => {
                const option = document.createElement('option');
                option.value = text;
                datalist.appendChild(option);
            });
        }
        

    }); // Fine DOMContentLoaded
    </script>
</body>
</html>
